<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BackProp ‚Äî IKB Engineering</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap');

:root {
  --bg: #0a0e13;
  --surface: #111720;
  --surface2: #161e2a;
  --surface3: #1c2535;
  --border: #2a3447;
  --border2: #3a4d66;
  --text: #dde8f5;
  --text-muted: #7d8590;
  --text-dim: #3d5170;
  --accent: #e8a020;
  --accent2: #4da8ff;
  --accent3: #38c96e;
  --danger: #f05050;
  --warn: #d4921a;
  --tg: #38c96e;
  --np: #f05050;
  --wet: #4da8ff;
  --ok: #38c96e;
  --prop: #c47dff;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }

body {
  font-family: 'DM Mono', monospace;
  background: var(--bg);
  color: var(--text);
  font-size: 12px;
  overflow: hidden;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  height: 52px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 16px;
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 200;
}
.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 17px;
  letter-spacing: -0.5px;
  color: var(--text);
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  line-height: 1.1;
}
.logo span { color: var(--accent); }
.logo-byline {
  font-size: 8px;
  font-family: 'DM Mono', monospace;
  font-weight: 300;
  color: var(--text-muted);
  letter-spacing: 0.8px;
  text-transform: uppercase;
  line-height: 1;
}

.nav-tabs {
  display: flex;
  gap: 2px;
  background: var(--bg);
  border-radius: 7px;
  padding: 3px;
  border: 1px solid var(--border);
}
.nav-tab {
  padding: 5px 14px;
  border-radius: 5px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.nav-tab.active {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
}
#tab-projects {
  color: var(--text-muted);
  border-right: 1px solid var(--border);
  margin-right: 2px;
  padding-right: 16px;
}
.nav-tab:hover:not(.active) { color: var(--text); }

.header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
.proj-info {
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  color: var(--text-muted);
  padding: 6px 13px;
  border: 1px solid var(--border);
  border-radius: 5px;
  background: var(--bg);
  cursor: pointer;
  transition: all 0.15s;
  display: flex; align-items: center; gap: 5px;
  white-space: nowrap;
}
.proj-info:hover { border-color: var(--border2); color: var(--text); }
.proj-info span { color: var(--accent); }

.btn {
  padding: 6px 13px;
  border-radius: 5px;
  border: 1px solid var(--border);
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-ghost { background: transparent; color: var(--text-muted); }
.btn-ghost:hover { background: var(--surface2); color: var(--text); border-color: var(--border2); }
.btn-accent { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 500; }
.btn-accent:hover { background: #cc8c15; }
.btn-calc-stale { background: var(--danger) !important; border-color: var(--danger) !important; color: #fff !important; }
.btn-calc-stale:hover { background: #c03030 !important; }
.btn-calc-ok { background: var(--tg) !important; border-color: var(--tg) !important; color: #000 !important; }
.btn-calc-ok:hover { background: #28a858 !important; }
.btn-blue { background: var(--accent2); color: #000; border-color: var(--accent2); font-weight: 500; }
.btn-blue:hover { background: #3a90e0; }
.btn-green { background: var(--tg); color: #000; border-color: var(--tg); font-weight: 500; }
.btn-green:hover { background: #28a858; }
.btn-sm { padding: 4px 9px; font-size: 10px; }
.btn-danger { background: rgba(240,80,80,0.15); color: var(--danger); border-color: rgba(240,80,80,0.3); }
.btn-danger:hover { background: rgba(240,80,80,0.25); }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app {
  margin-top: 52px;
  height: calc(100vh - 52px);
  display: flex;
  overflow: hidden;
}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page { display: none; width: 100%; height: 100%; overflow: auto; }
.page.active { display: flex; flex-direction: column; }

/* ‚îÄ‚îÄ BUILDING LEVELS PAGE ‚îÄ‚îÄ */
.page-header {
  padding: 20px 28px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-end;
  gap: 16px;
  flex-shrink: 0;
}
.page-title {
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 700;
}
.page-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

.page-content { flex: 1; overflow: auto; padding: 24px 28px; }

/* Building stack visualisation */
.building-editor {
  display: grid;
  grid-template-columns: 1fr 360px;
  gap: 20px;
  max-width: 1200px;
}

.levels-stack {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}
.levels-stack-header {
  display: grid;
  grid-template-columns: 36px 120px 100px 36px;
  gap: 0;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  padding: 0 12px;
}
.col-head {
  padding: 8px 6px;
  font-size: 10px;
  color: var(--text-muted);
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.level-row {
  display: grid;
  grid-template-columns: 36px 120px 100px 36px;
  gap: 0;
  padding: 4px 12px;
  border-bottom: 1px solid var(--border);
  align-items: center;
  transition: background 0.1s;
}
.level-row:hover { background: var(--surface2); }
.level-row:last-child { border-bottom: none; }
.level-row.is-ground { background: rgba(56,201,110,0.05); }
.level-row.is-ground:hover { background: rgba(56,201,110,0.08); }

.level-badge {
  font-size: 10px;
  color: var(--text-dim);
  text-align: center;
  font-style: italic;
}
.level-badge.ground { color: var(--tg); font-style: normal; font-weight: 500; }

.row-input {
  background: transparent;
  border: 1px solid transparent;
  color: var(--text);
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 4px;
  width: 100%;
  outline: none;
  transition: border-color 0.1s;
}
.row-input:hover { border-color: var(--border); }
.row-input:focus { border-color: var(--accent2); background: var(--surface2); }
.row-input.name { font-weight: 500; font-size: 13px; }

.level-zones-btn {
  font-size: 10px;
  padding: 3px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.level-zones-btn:hover { border-color: var(--accent2); color: var(--accent2); background: rgba(77,168,255,0.05); }
.level-zones-btn.has-zones { border-color: rgba(77,168,255,0.4); color: var(--accent2); background: rgba(77,168,255,0.07); }

.add-level-row {
  padding: 10px 12px;
  border-top: 1px dashed var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 11px;
  transition: all 0.15s;
}
.add-level-row:hover { color: var(--accent2); background: rgba(77,168,255,0.03); }

.del-btn {
  background: transparent;
  border: none;
  color: var(--text-dim);
  cursor: pointer;
  font-size: 15px;
  line-height: 1;
  padding: 3px 5px;
  border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.1s;
}
.del-btn:hover { color: var(--danger); background: rgba(240,80,80,0.1); }

/* Right panel */
.levels-sidebar {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}
.panel-header {
  padding: 12px 16px;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  font-weight: 700;
  display: flex; align-items: center; gap: 8px; justify-content: space-between;
}
.panel-body { padding: 14px 16px; }
.field-group { margin-bottom: 10px; }
.field-group:last-child { margin-bottom: 0; }
.field-label { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; display: block; }
.field-input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 5px;
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  outline: none;
  transition: border-color 0.15s;
}
.field-input:focus { border-color: var(--accent2); }
.field-row { display: flex; gap: 8px; }
.field-row .field-group { flex: 1; }

/* ‚îÄ‚îÄ ZONES PAGE ‚îÄ‚îÄ */
.zones-page { padding: 24px 28px; max-width: 1200px; }
.zones-breadcrumb {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 6px;
}
.zones-breadcrumb a {
  color: var(--accent2);
  cursor: pointer;
  text-decoration: none;
}
.zones-breadcrumb a:hover { text-decoration: underline; }
.zones-breadcrumb span { color: var(--text-dim); }

.zones-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
  gap: 14px;
  margin-bottom: 16px;
}
.zone-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  transition: border-color 0.15s;
}
.zone-card:hover { border-color: var(--border2); }
.zone-card-header {
  background: var(--surface2);
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.zone-card-title {
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  font-weight: 700;
  color: var(--accent);
  display: flex; align-items: center; gap: 8px;
}
.zone-thickness-badge {
  font-family: 'Syne', sans-serif;
  font-size: 10px;
  padding: 2px 7px;
  background: rgba(77,168,255,0.1);
  border: 1px solid rgba(77,168,255,0.25);
  border-radius: 10px;
  color: var(--wet);
}

.zone-body { padding: 12px 14px; }
.zone-field { margin-bottom: 8px; }
.zone-field label { font-size: 10px; color: var(--text-muted); margin-bottom: 3px; display: block; }
.zone-input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 5px 9px;
  border-radius: 4px;
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  outline: none;
  transition: border-color 0.15s;
}
.zone-input:focus { border-color: var(--accent2); }

/* Zone levels table */
.zone-levels-table {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
}
.zone-levels-table-header {
  display: grid;
  grid-template-columns: 24px 54px 74px 74px minmax(160px, 1fr);
  gap: 0;
  background: var(--surface3);
  border-bottom: 1px solid var(--border);
  padding: 0 8px;
}
.zone-col-head {
  padding: 5px 4px;
  font-size: 9px;
  color: var(--text-muted);
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}
.zone-level-row {
  display: grid;
  grid-template-columns: 24px 54px 74px 74px minmax(160px, 1fr);
  gap: 0;
  padding: 2px 8px;
  border-bottom: 1px solid rgba(42,52,71,0.5);
  align-items: center;
  transition: background 0.1s;
}
.zone-level-row:last-child { border-bottom: none; }
.zone-level-row.checked { background: rgba(77,168,255,0.04); }
.zone-level-row.disabled { opacity: 0.35; }

.zone-check {
  appearance: none;
  width: 13px; height: 13px;
  border: 1px solid var(--border2);
  border-radius: 3px;
  background: var(--surface2);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  position: relative;
  transition: all 0.1s;
  flex-shrink: 0;
}
.zone-check:checked {
  background: var(--accent2);
  border-color: var(--accent2);
}
.zone-check:checked::after {
  content: '‚úì';
  position: absolute;
  font-size: 9px;
  color: #000;
  font-weight: 700;
}

.zone-lvl-name {
  font-size: 11px;
  font-weight: 500;
  color: var(--text);
  padding: 0 4px;
}
.zone-lvl-input {
  background: transparent;
  border: 1px solid transparent;
  color: var(--text);
  font-family: 'Syne', sans-serif;
  font-size: 11px;
  padding: 3px 5px;
  border-radius: 3px;
  width: 100%;
  outline: none;
  transition: border-color 0.1s;
}
.zone-lvl-input:hover:not(:disabled) { border-color: var(--border); }
.zone-lvl-input:focus:not(:disabled) { border-color: var(--accent2); background: var(--surface2); }
.zone-lvl-input:disabled { opacity: 0.3; cursor: not-allowed; }

/* Prop selector in zone */
.prop-selector-row {
  display: flex; gap: 6px; align-items: center;
}
.prop-select {
  flex: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 4px 8px;
  border-radius: 4px;
  font-family: 'Syne', sans-serif;
  font-size: 11px;
  outline: none;
  cursor: pointer;
}
.prop-select:focus { border-color: var(--accent2); }

.add-zone-btn {
  border: 1px dashed var(--border);
  border-radius: 10px;
  padding: 14px;
  text-align: center;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 11px;
  transition: all 0.15s;
  background: transparent;
  width: 100%;
  display: block;
}
.add-zone-btn:hover { border-color: var(--accent2); color: var(--accent2); background: rgba(77,168,255,0.03); }

/* ‚îÄ‚îÄ PROP LIBRARY PAGE ‚îÄ‚îÄ */
.prop-library-wrap { padding: 24px 28px; max-width: 1100px; }
.prop-library-grid {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
}
.prop-table-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}
.prop-table-head {
  display: grid;
  grid-template-columns: 1fr 120px 100px 80px 44px;
  gap: 0;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  padding: 0 14px;
}
.prop-col-head {
  padding: 9px 6px;
  font-size: 10px;
  color: var(--text-muted);
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.prop-row {
  display: grid;
  grid-template-columns: 1fr 120px 100px 80px 44px;
  gap: 0;
  padding: 4px 14px;
  border-bottom: 1px solid var(--border);
  align-items: center;
  transition: background 0.1s;
}
.prop-row:hover { background: var(--surface2); }
.prop-row:last-child { border-bottom: none; }
.prop-row-name { font-size: 12px; font-weight: 500; }
.prop-cap-badge {
  display: inline-flex;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  background: rgba(196,125,255,0.12);
  border: 1px solid rgba(196,125,255,0.25);
  color: var(--prop);
  font-weight: 500;
}
.prop-default-star {
  color: var(--accent);
  font-size: 12px;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 3px;
  transition: opacity 0.1s;
}
.prop-default-star:hover { opacity: 0.7; }
.prop-empty {
  padding: 40px;
  text-align: center;
  color: var(--text-muted);
  font-size: 12px;
}
.prop-empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.3; }
.add-prop-row {
  padding: 10px 14px;
  border-top: 1px dashed var(--border);
  display: flex; align-items: center; gap: 8px;
  cursor: pointer; color: var(--text-muted); font-size: 11px;
  transition: all 0.15s;
}
.add-prop-row:hover { color: var(--prop); background: rgba(196,125,255,0.03); }

.prop-form {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  position: sticky;
  top: 0;
}

/* ‚îÄ‚îÄ ENGINEER VIEW (results) ‚îÄ‚îÄ */
.engineer-layout {
  display: flex;
  width: 100%;
  height: 100%;
}
.engineer-sidebar {
  width: 300px;
  min-width: 300px;
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}
.e-sidebar-section {
  border-bottom: 1px solid var(--border);
  padding: 14px 16px;
}
.e-sidebar-title {
  font-family: 'Syne', sans-serif;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  margin-bottom: 10px;
}
.engineer-main { flex: 1; overflow: auto; padding: 24px; }

.results-title {
  font-family: 'Syne', sans-serif;
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 4px;
  display: flex; align-items: center; gap: 10px;
}
.results-sub { font-size: 10px; color: var(--text-muted); margin-bottom: 14px; }
.tag {
  display: inline-flex;
  padding: 2px 7px;
  border-radius: 8px;
  font-size: 10px;
  background: rgba(232,160,32,0.12);
  color: var(--accent);
  border: 1px solid rgba(232,160,32,0.25);
}

.matrix-container { overflow-x: auto; margin-bottom: 24px; }
.matrix-table {
  border-collapse: collapse;
  font-size: 11px;
  min-width: max-content;
}
.matrix-table th {
  background: var(--surface2);
  color: var(--text-muted);
  padding: 6px 10px;
  font-weight: 500;
  text-align: center;
  border: 1px solid var(--border);
  white-space: nowrap;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.matrix-table th.col-pour {
  background: var(--surface);
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
  cursor: pointer;
}
.matrix-table th.col-pour:hover { background: rgba(232,160,32,0.05); }
.matrix-table td {
  padding: 5px 10px;
  border: 1px solid var(--border);
  text-align: center;
  min-width: 70px;
  white-space: nowrap;
}
.matrix-table td.row-label {
  background: var(--surface2);
  color: var(--text-muted);
  text-align: left;
  font-size: 10px;
  padding-left: 10px;
}
.cell-wet { background: rgba(0,178,178,0.1); color: var(--wet); font-style: italic; }
.cell-tg { background: rgba(56,201,110,0.1); color: var(--tg); }
.cell-np { background: rgba(240,80,80,0.12); color: var(--np); font-weight: 500; }
.cell-ok { background: rgba(56,201,110,0.06); color: var(--ok); }
.cell-warn { background: rgba(196,122,0,0.1); color: var(--warn); }
.cell-empty { background: var(--bg); color: var(--border); }
.cell-inactive { background: rgba(8,20,20,0.6); color: var(--text-dim); font-size: 9px; }

/* ‚îÄ‚îÄ BUILDER VIEW ‚îÄ‚îÄ */
.builder-layout {
  display: flex;
  width: 100%;
  height: 100%;
}
.builder-sidebar {
  width: 260px;
  min-width: 260px;
  border-right: 1px solid var(--border);
  overflow-y: auto;
  padding: 14px;
  flex-shrink: 0;
}
.builder-main { flex: 1; overflow: auto; padding: 24px; }

.pour-list { display: flex; flex-direction: column; gap: 4px; }
.pour-item {
  padding: 7px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text-muted);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
}
.pour-item:hover { border-color: var(--border2); color: var(--text); }
.pour-item.active { background: var(--surface2); color: var(--text); border-color: var(--accent); }
.pour-item-name { font-weight: 500; font-size: 12px; }
.pour-item-sub { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

.sidebar-pour-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  padding: 5px 6px;
  border-bottom: 1px solid rgba(42,52,71,0.4);
  border-radius: 4px;
  transition: background 0.1s;
}
.sidebar-pour-item:hover {
  background: var(--surface2);
}

.building-vis-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 16px;
}
.vis-level {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 3px;
}
.vis-label { width: 55px; text-align: right; font-size: 11px; color: var(--text-muted); flex-shrink: 0; }
.vis-bar {
  flex: 1;
  height: 30px;
  border-radius: 4px;
  display: flex; align-items: center; padding: 0 10px;
  font-size: 11px; font-weight: 500;
  border: 1px solid transparent;
  min-width: 180px;
  position: relative;
  overflow: hidden;
  transition: all 0.25s;
}
.vis-bar::before {
  content: '';
  position: absolute; left:0; top:0; bottom:0;
  width: 30%;
  background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, transparent 100%);
  pointer-events: none;
}
.vis-badge { display: none; } /* badges removed ‚Äî info is now in bar text */

.slab-wet { background: linear-gradient(135deg,#102035,#172d4a); border-color:var(--wet); color:var(--wet); animation: pulse-wet 2s infinite; }
@keyframes pulse-wet { 0%,100%{box-shadow:0 0 0 0 rgba(77,168,255,0.15)} 50%{box-shadow:0 0 0 4px rgba(77,168,255,0.07)} }
.slab-tg { background: linear-gradient(135deg,#0d2419,#122e1e); border-color:var(--tg); color:var(--tg); }
.slab-ok { background: linear-gradient(135deg,#0b1e13,#10271a); border-color:rgba(56,201,110,0.25); color:var(--tg); }
.slab-np { background: linear-gradient(135deg,#2a1010,#381515); border-color:var(--np); color:var(--np); }
.slab-warn { background: linear-gradient(135deg,#271c08,#332410); border-color:var(--warn); color:var(--warn); }
.slab-neutral { background: var(--surface2); border-color:var(--border); color:var(--text-muted); }

.badge-tg { background:rgba(56,201,110,0.12); color:var(--tg); border:1px solid rgba(56,201,110,0.25); }
.badge-ok { background:rgba(56,201,110,0.08); color:var(--tg); border:1px solid rgba(56,201,110,0.15); }
.badge-warn { background:rgba(212,146,26,0.12); color:var(--warn); border:1px solid rgba(212,146,26,0.25); }
.badge-np { background:rgba(240,80,80,0.12); color:var(--np); border:1px solid rgba(240,80,80,0.25); }
.badge-wet { background:rgba(77,168,255,0.1); color:var(--wet); border:1px solid rgba(77,168,255,0.2); }
.badge-neutral { background:var(--surface2); color:var(--text-muted); border:1px solid var(--border); }

.vis-props { display:flex; align-items:flex-end; gap:2px; margin:2px 0 2px 65px; height:12px; }
.vis-prop-line { background:var(--accent); width:2px; border-radius:1px; opacity:0.6; }

.builder-legend { display:flex; gap:14px; flex-wrap:wrap; padding:10px 14px; background:var(--bg); border-radius:6px; margin-bottom:16px; }
.legend-item { display:flex; align-items:center; gap:6px; font-size:10px; color:var(--text-muted); }
.legend-swatch { width:11px; height:11px; border-radius:2px; border:1px solid currentColor; }

.summary-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}
.summary-panel-header {
  background: var(--surface2);
  padding: 11px 16px;
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  font-weight: 700;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.pass-badge {
  padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 500;
}
.pass-badge.pass { background:rgba(56,201,110,0.12); color:var(--tg); }
.pass-badge.fail { background:rgba(240,80,80,0.12); color:var(--np); }
.pass-badge.partial { background:rgba(212,146,26,0.12); color:var(--warn); }
.summary-body { padding: 14px 16px; }
.info-row { display:flex; justify-content:space-between; font-size:11px; padding:3px 0; border-bottom:1px solid rgba(42,52,71,0.4); }
.info-row:last-child { border-bottom:none; }
.info-key { color:var(--text-muted); }
.info-val { font-weight:500; }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset:0;
  background: rgba(0,0,0,0.75);
  display: none;
  align-items: center; justify-content: center;
  z-index: 500;
  backdrop-filter: blur(6px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  width: 460px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
}
.modal-title { font-family:'Syne',sans-serif; font-size:16px; font-weight:700; margin-bottom:6px; }
.modal-sub { font-size:11px; color:var(--text-muted); margin-bottom:18px; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
.drop-zone {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 32px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 14px;
}
.drop-zone:hover, .drop-zone.drag-over { border-color:var(--accent2); background:rgba(77,168,255,0.04); }
.drop-zone-icon { font-size:30px; margin-bottom:8px; }
.drop-zone-text { color:var(--text-muted); font-size:11px; }
.drop-zone-text strong { color:var(--accent2); }

/* ‚îÄ‚îÄ PROJ SETTINGS MODAL ‚îÄ‚îÄ */
.proj-modal-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 11px 16px;
  font-size: 11px;
  transform: translateY(20px);
  opacity: 0;
  transition: all 0.25s;
  max-width: 300px;
  pointer-events: none;
  font-family: 'DM Mono', monospace;
  line-height: 1.4;
}
.toast.show { transform:translateY(0); opacity:1; }
.toast.hiding { transform:translateY(20px); opacity:0; }
.toast.success { border-color:var(--tg); }
.toast.error { border-color:var(--np); }
.toast.info { border-color:var(--accent2); }

/* ‚îÄ‚îÄ EMPTY STATES ‚îÄ‚îÄ */
.empty-state {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 300px; color: var(--text-muted); text-align: center;
}
.empty-icon { font-size: 44px; margin-bottom:12px; opacity:0.3; }
.empty-text { font-size:13px; }
.empty-hint { font-size:11px; margin-top:6px; }

/* Scrollbar */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--border2); }

.divider { height:1px; background:var(--border); margin:10px 0; }

.chip {
  display:inline-flex; padding:2px 8px; border-radius:8px; font-size:10px;
  background:rgba(77,168,255,0.1); color:var(--accent2); border:1px solid rgba(77,168,255,0.2);
}
.chip-green { background:rgba(56,201,110,0.1); color:var(--tg); border-color:rgba(56,201,110,0.2); }
.chip-purple { background:rgba(196,125,255,0.1); color:var(--prop); border-color:rgba(196,125,255,0.2); }
.chip-warn { background:rgba(212,146,26,0.1); color:var(--warn); border-color:rgba(212,146,26,0.2); }

/* ‚îÄ‚îÄ PROJECT LIST SCREEN ‚îÄ‚îÄ */
#projectListScreen {
  position: fixed; inset: 0; z-index: 500;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center;
  overflow-y: auto;
  padding: 60px 24px 40px;
}
.proj-screen-header {
  text-align: center;
  margin-bottom: 40px;
}
.proj-screen-logo {
  font-family: 'Syne', sans-serif;
  font-size: 28px; font-weight: 800;
  margin-bottom: 6px;
}
.proj-screen-logo span { color: var(--accent); }
.proj-screen-sub { font-size: 12px; color: var(--text-muted); }
.proj-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 14px;
  width: 100%;
  max-width: 1000px;
}
.proj-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 18px 20px;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
}
.proj-card:hover { border-color: var(--accent); background: var(--surface2); }
.proj-card-name {
  font-family: 'Syne', sans-serif;
  font-size: 14px; font-weight: 700;
  margin-bottom: 4px;
}
.proj-card-meta { font-size: 11px; color: var(--text-muted); margin-bottom: 10px; }
.proj-card-stats { display: flex; gap: 10px; font-size: 10px; color: var(--text-muted); }
.proj-card-stat { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.proj-card-stat-val { font-size: 14px; font-weight: 600; color: var(--text); font-family: 'Syne', sans-serif; }
.proj-card-del {
  position: absolute; top: 10px; right: 10px;
  background: transparent; border: none; color: var(--text-dim);
  cursor: pointer; font-size: 14px; line-height: 1; padding: 2px 5px;
  border-radius: 4px;
  transition: all 0.1s;
}
.proj-card-del:hover { color: var(--danger); background: rgba(240,80,80,0.1); }
.proj-card-new {
  border: 1px dashed var(--border2);
  background: transparent;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 6px; color: var(--text-muted);
  min-height: 120px;
}
.proj-card-new:hover { border-color: var(--accent); color: var(--accent); background: rgba(232,160,32,0.03); }
.proj-new-icon { font-size: 28px; opacity: 0.4; }
.proj-new-label { font-size: 12px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOADING SCREEN ‚ïê‚ïê -->
<div id="loadingScreen" style="display:flex;position:fixed;inset:0;background:#0a0e13;z-index:10000;align-items:center;justify-content:center;flex-direction:column;gap:12px">
  <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;letter-spacing:-0.5px;color:#dde8f5">BACK<span style="color:#e8a020">PROP</span></div>
  <div style="font-size:10px;font-family:'DM Mono',monospace;color:#7d8590;letter-spacing:2px">LOADING‚Ä¶</div>
</div>

<!-- ‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê -->
<div id="authScreen" style="display:none;position:fixed;inset:0;background:#0a0e13;z-index:9999;align-items:center;justify-content:center;flex-direction:column">
  <div style="width:360px">
    <div style="text-align:center;margin-bottom:32px">
      <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;letter-spacing:-0.5px">BACK<span style="color:#e8a020">PROP</span></div>
      <div style="font-size:10px;font-family:'DM Mono',monospace;color:#7d8590;letter-spacing:1px;margin-top:4px">BY IKB ENGINEERING</div>
    </div>
    <div style="background:#111720;border:1px solid #2a3447;border-radius:12px;padding:28px">
      <div style="display:flex;margin-bottom:24px;background:#0a0e13;border-radius:6px;padding:3px;border:1px solid #2a3447">
        <button id="tabSignin" style="flex:1;padding:6px;border:none;border-radius:4px;background:#161e2a;color:#dde8f5;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer" onclick="setAuthMode('signin')">Sign In</button>
        <button id="tabSignup" style="flex:1;padding:6px;border:none;border-radius:4px;background:transparent;color:#7d8590;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer" onclick="setAuthMode('signup')">Sign Up</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:12px">
        <div>
          <label style="font-size:10px;color:#7d8590;font-family:'DM Mono',monospace;display:block;margin-bottom:4px">EMAIL</label>
          <input id="authEmail" type="email" placeholder="you@example.com" style="width:100%;box-sizing:border-box;background:#0a0e13;border:1px solid #2a3447;border-radius:5px;padding:8px 10px;color:#dde8f5;font-family:'DM Mono',monospace;font-size:12px;outline:none">
        </div>
        <div>
          <label style="font-size:10px;color:#7d8590;font-family:'DM Mono',monospace;display:block;margin-bottom:4px">PASSWORD</label>
          <input id="authPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;box-sizing:border-box;background:#0a0e13;border:1px solid #2a3447;border-radius:5px;padding:8px 10px;color:#dde8f5;font-family:'DM Mono',monospace;font-size:12px;outline:none" onkeydown="if(event.key==='Enter')handleAuth()">
        </div>
        <div id="authError" style="display:none;color:#f05050;font-size:11px;font-family:'DM Mono',monospace;padding:8px;background:rgba(240,80,80,0.08);border-radius:4px"></div>
        <button id="authBtn" onclick="handleAuth()" style="margin-top:4px;padding:10px;background:#e8a020;color:#000;border:none;border-radius:5px;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;cursor:pointer">Sign In</button>
      </div>
      <div id="authMsg" style="display:none;margin-top:16px;text-align:center;font-size:11px;color:#38c96e;font-family:'DM Mono',monospace"></div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê PROJECT LIST SCREEN ‚ïê‚ïê -->
<div id="projectListScreen" style="display:none">
  <div class="proj-screen-header">
    <div class="proj-screen-logo">BACK<span>PROP</span><sub style="font-size:11px;font-family:'DM Mono';font-weight:300;color:var(--text-muted);margin-left:4px;letter-spacing:1px">v2</sub></div>
    <div class="proj-screen-sub">IKB Engineering ‚Äî Back-Propping Design Tool</div>
  </div>
  <div class="proj-grid" id="projGrid"></div>
</div>

<!-- ‚ïê‚ïê APP SHELL (hidden until logged in) ‚ïê‚ïê -->
<div id="appShell" style="display:none">

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header>
  <div class="logo">
    <div>BACK<span>PROP</span></div>
    <div class="logo-byline">By IKB Engineering</div>
  </div>

  <div class="nav-tabs">
    <button class="nav-tab" onclick="showProjectList()" id="tab-projects">‚Üê Projects</button>
    <button class="nav-tab active" onclick="showPage('levels')" id="tab-levels">üèó Building Levels</button>
    <button class="nav-tab" onclick="showPage('engineer')" id="tab-engineer">‚öô Engineer View</button>
    <button class="nav-tab" onclick="showPage('builder')" id="tab-builder">üë∑ Builder View</button>
  </div>

  <div class="header-right">
    <button class="proj-info" onclick="openProjModal()">
      <span id="headerProjName">New Project</span> ¬∑ <span style="color:var(--text-muted)" id="headerJobNo">‚Äî</span>
    </button>
    <button class="btn btn-ghost" onclick="openImport()">‚¨Ü Import</button>
    <button class="btn btn-ghost" onclick="exportResults()">‚¨á Export</button>
    <button class="btn btn-ghost" onclick="signOut()" style="font-size:10px" title="Sign out">‚éã Sign out</button>
    <button class="btn btn-accent" id="calcBtn" onclick="runCalc()">‚ñ∂ Calculate</button>
  </div>
</header>

<!-- ‚ïê‚ïê TOAST ‚ïê‚ïê -->
<div id="toastContainer" style="position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column-reverse;gap:8px;z-index:9000;pointer-events:none"></div>

<!-- ‚ïê‚ïê IMPORT MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="importModal">
  <div class="modal">
    <div class="modal-title">Import Spreadsheet</div>
    <div class="modal-sub">Import an existing back-propping XLSX. Reads levels from THICKNESS and CAPACITY sheets.</div>
    <div class="drop-zone" id="dropZone"
      onclick="document.getElementById('file-input').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleDrop(event)">
      <div class="drop-zone-icon">üìÇ</div>
      <div class="drop-zone-text"><strong>Click to browse</strong> or drag & drop<br>XLSX files only</div>
    </div>
    <input type="file" id="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)" style="display:none">
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeImport()">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PROJECT SETTINGS MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="projModal">
  <div class="modal">
    <div class="modal-title">Project Settings</div>
    <div class="modal-sub">Configure project details and engineering parameters.</div>
    <div class="proj-modal-grid">
      <div class="field-group" style="grid-column:1/-1">
        <label class="field-label">Project Name</label>
        <input class="field-input" id="projName" value="Project 10354">
      </div>
      <div class="field-group">
        <label class="field-label">Job Number</label>
        <input class="field-input" id="jobNo" value="10354">
      </div>
      <div class="field-group">
        <label class="field-label">Prepared By</label>
        <input class="field-input" id="prepBy" value="">
      </div>
    </div>
    <div class="divider"></div>
    <div style="font-family:'Syne',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);margin-bottom:10px">Engineering Parameters</div>
    <div class="proj-modal-grid">
      <div class="field-group">
        <label class="field-label">Concrete density (kN/m¬≥)</label>
        <input class="field-input" id="concDensity" type="number" value="24" step="0.5">
      </div>
      <div class="field-group">
        <label class="field-label">Max prop spacing (m)</label>
        <input class="field-input" id="maxSpacing" type="number" value="3.0" step="0.1">
      </div>
    </div>
    <div class="divider"></div>
    <div style="font-family:'Syne',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);margin-bottom:10px">Prop Library</div>
    <div id="projModalPropTable" style="margin-bottom:8px"></div>
    <div id="projModalPropForm" style="background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;display:none">
      <div style="font-size:11px;font-weight:700;font-family:'Syne',sans-serif;margin-bottom:10px" id="modalPropFormTitle">Add Prop</div>
      <input type="hidden" id="modalPropEditId">
      <div class="proj-modal-grid">
        <div class="field-group">
          <label class="field-label">Type / Model</label>
          <input class="field-input" id="modalPropType" placeholder="e.g. Acrow #2">
        </div>
        <div class="field-group">
          <label class="field-label">Extension</label>
          <input class="field-input" id="modalPropExtension" placeholder="e.g. 2.0‚Äì3.4m">
        </div>
        <div class="field-group">
          <label class="field-label">Capacity (kN)</label>
          <input class="field-input" type="number" id="modalPropCapacity" placeholder="e.g. 22" step="0.5">
        </div>
        <div class="field-group">
          <label class="field-label">Notes (optional)</label>
          <input class="field-input" id="modalPropNotes" placeholder="Manufacturer, load case‚Ä¶">
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-accent" style="flex:1" onclick="saveModalProp()">Save Prop</button>
        <button class="btn btn-ghost" onclick="clearModalPropForm()">Cancel</button>
      </div>
    </div>
    <button class="btn btn-ghost" style="width:100%;margin-bottom:12px" onclick="showModalPropForm()">+ Add Prop</button>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeProjModal()">Cancel</button>
      <button class="btn btn-accent" onclick="saveProjSettings()">Save</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div class="app">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PAGE 1: BUILDING LEVELS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="page active" id="page-levels">
    <div class="page-header">
      <div>
        <div class="page-title">Building Levels</div>
        <div class="page-subtitle">Construct the building from bottom to top. Enter each level name, then open Zones to define the pour configuration.</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="addLevel()">+ Add Level</button>
      </div>
    </div>
    <div class="page-content">
      <div class="building-editor">

        <!-- Levels Stack -->
        <div>
          <div class="levels-stack">
            <div class="levels-stack-header">
              <div class="col-head" style="text-align:center">#</div>
              <div class="col-head">Level Name</div>
              <div class="col-head">Zones</div>
              <div class="col-head"></div>
            </div>
            <div class="add-level-row" onclick="addLevel()" style="border-top:none;border-bottom:1px dashed var(--border)">
              <span style="font-size:16px;line-height:1">+</span> Add Level (builds upward ‚Üë)
            </div>
            <div id="levelsBody"></div>
          </div>
        </div>

        <!-- Right Panel -->
        <div class="levels-sidebar">
          <div class="panel">
            <div class="panel-header">
              <span>Project Summary</span>
            </div>
            <div class="panel-body" id="projectSummaryPanel">
              <div class="info-row"><span class="info-key">Total levels</span><span class="info-val" id="sumLevels">0</span></div>
              <div class="info-row"><span class="info-key">Total zones</span><span class="info-val" id="sumZones">0</span></div>
              <div class="info-row"><span class="info-key">Props in library</span><span class="info-val" id="sumProps">0</span></div>
              <div class="info-row"><span class="info-key">Status</span><span class="info-val" id="sumStatus"><span class="chip-warn chip">Not calculated</span></span></div>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header"><span>Quick Help</span></div>
            <div class="panel-body" style="font-size:11px;color:var(--text-muted);line-height:1.7">
              <div style="margin-bottom:8px">‚ë† The <strong style="color:var(--tg)">Base Level</strong> is always the lowest level ‚Äî rename it as needed (e.g. Ground, Podium).</div>
              <div style="margin-bottom:8px">‚ë° Add levels <strong style="color:var(--text)">above</strong> the base using <em>Add Level</em> ‚Äî they build upward.</div>
              <div style="margin-bottom:8px">‚ë¢ Click <strong style="color:var(--accent2)">Zones ‚Üí</strong> on any upper level to define pour zones and back-propping.</div>
              <div>‚ë£ Hit <strong style="color:var(--accent)">Calculate</strong> to run the back-propping analysis.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PAGE 1b: ZONES (within a level)
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-zones">
    <div class="page-header">
      <div>
        <div class="zones-breadcrumb">
          <a onclick="showPage('levels')">‚Üê Building Levels</a>
          <span>/</span>
          <span id="zonesBreadcrumbLevel" style="color:var(--text)">Level 4</span>
        </div>
        <div class="page-title" id="zonesPageTitle">Level 4 ‚Äî Zones</div>
        <div class="page-subtitle">Define pour zones for this level. Each zone represents a slab area with its own wet concrete thickness and back-propping arrangement.</div>
      </div>
      <div style="margin-left:auto">
        <button class="btn btn-green btn-sm" onclick="addZone()">+ Add Zone</button>
      </div>
    </div>
    <div class="page-content">
      <div class="zones-page" id="zonesContent" style="padding:0">
        <div class="zones-grid" id="zonesGrid"></div>
        <button class="add-zone-btn" onclick="addZone()">+ Add Zone to this Level</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PAGE 3: ENGINEER VIEW
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-engineer">
    <div class="engineer-layout">
      <div class="engineer-sidebar">
        <div class="e-sidebar-section">
          <div class="e-sidebar-title">Project</div>
          <div style="font-size:12px;font-weight:500" id="engProjName">Project 10354</div>
          <div style="font-size:10px;color:var(--text-muted)" id="engJobNo">Job No. 10354</div>
        </div>
        <div class="e-sidebar-section">
          <div class="e-sidebar-title">Parameters</div>
          <div class="info-row">
            <span class="info-key">Density kN/m¬≥</span>
            <input type="number" id="engDensity" value="24" step="0.5" min="10" max="30"
              style="background:var(--surface3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:11px;padding:2px 6px;border-radius:4px;width:64px;text-align:right"
              onchange="project.concDensity=+this.value;markDirty();"
              title="Concrete density ‚Äî recalculate after changing">
          </div>
          <div class="info-row">
            <span class="info-key">Max spacing m</span>
            <input type="number" id="engSpacing" value="3.0" step="0.1" min="0.5" max="6"
              style="background:var(--surface3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:11px;padding:2px 6px;border-radius:4px;width:64px;text-align:right"
              onchange="project.maxSpacing=+this.value;markDirty();"
              title="Max prop spacing ‚Äî recalculate after changing">
          </div>
        </div>
        <div class="e-sidebar-section" id="engPoursList">
          <div class="e-sidebar-title">Pour Scenarios</div>
          <div id="engPoursBody" style="font-size:11px;color:var(--text-muted)">No results yet</div>
        </div>
      </div>
      <div class="engineer-main" id="engineerMain">
        <div class="empty-state">
          <div class="empty-icon">‚öô</div>
          <div class="empty-text">Configure levels & zones, then click Calculate</div>
          <div class="empty-hint">Results will appear here</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PAGE 4: BUILDER VIEW
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-builder">
    <div class="builder-layout">
      <div class="builder-sidebar">
        <div style="font-family:'Syne',sans-serif;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:10px">
          Pour / Zone
        </div>
        <div class="pour-list" id="builderPourList">
          <div style="font-size:11px;color:var(--text-muted)">No results yet ‚Äî click Calculate</div>
        </div>
      </div>
      <div class="builder-main">
        <div id="builderContent">
          <div class="empty-state">
            <div class="empty-icon">üë∑</div>
            <div class="empty-text">Select a pour to view back-propping visualisation</div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div><!-- /app -->
</div><!-- /appShell -->

<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE CONFIG + AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPA_URL = 'https://kwbmiyjwmsuqllbqwudo.supabase.co';
const SUPA_KEY = 'sb_publishable_J0mPoTMrkZEj-9Nq2x-VWw_SkhRxr28';
const { createClient } = supabase;
const supa = createClient(SUPA_URL, SUPA_KEY);
let currentUser = null;
let authMode = 'signin';

function setAuthMode(mode) {
  authMode = mode;
  document.getElementById('tabSignin').style.background = mode === 'signin' ? '#161e2a' : 'transparent';
  document.getElementById('tabSignin').style.color = mode === 'signin' ? '#dde8f5' : '#7d8590';
  document.getElementById('tabSignup').style.background = mode === 'signup' ? '#161e2a' : 'transparent';
  document.getElementById('tabSignup').style.color = mode === 'signup' ? '#dde8f5' : '#7d8590';
  document.getElementById('authBtn').textContent = mode === 'signin' ? 'Sign In' : 'Create Account';
  document.getElementById('authError').style.display = 'none';
  document.getElementById('authMsg').style.display = 'none';
}

async function handleAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const errEl = document.getElementById('authError');
  const msgEl = document.getElementById('authMsg');
  errEl.style.display = 'none';
  msgEl.style.display = 'none';
  if (!email || !password) { errEl.textContent = 'Please enter email and password.'; errEl.style.display = 'block'; return; }
  document.getElementById('authBtn').textContent = '‚Ä¶';
  if (authMode === 'signup') {
    const { data, error } = await supa.auth.signUp({ email, password });
    if (error) {
      errEl.textContent = error.message;
      errEl.style.display = 'block';
    } else if (data.user && data.user.identities && data.user.identities.length === 0) {
      // Supabase returns a fake success when email already exists ‚Äî detect by empty identities
      errEl.textContent = 'An account with this email already exists. Please sign in instead.';
      errEl.style.display = 'block';
      // Switch to sign in tab after a moment
      setTimeout(() => setAuthMode('signin'), 1500);
    } else {
      msgEl.textContent = 'Account created! Check your email to confirm, then sign in.';
      msgEl.style.display = 'block';
    }
  } else {
    const { error } = await supa.auth.signInWithPassword({ email, password });
    if (error) {
      // Make the error message more user-friendly
      if (error.message.includes('Invalid login credentials')) {
        errEl.textContent = 'Incorrect email or password.';
      } else {
        errEl.textContent = error.message;
      }
      errEl.style.display = 'block';
    }
  }
  document.getElementById('authBtn').textContent = authMode === 'signin' ? 'Sign In' : 'Create Account';
  // Clear password field after any attempt; clear email too on successful signup
  document.getElementById('authPassword').value = '';
}

async function signOut() {
  await supa.auth.signOut();
  currentUser = null;
  projectStore = [];
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('projectListScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'none';
}

let _authInitializing = true;

// Check session immediately on load ‚Äî prevents flash of login screen
async function initAuth() {
  try {
    const { data } = await supa.auth.getSession();
    const session = data.session;
    _authInitializing = false;
    document.getElementById('loadingScreen').style.display = 'none';
    if (session && session.user) {
      currentUser = session.user;
        await dbLoadProjects();
      document.getElementById('projectListScreen').style.display = 'flex';
      renderProjectList();
    } else {
      document.getElementById('authScreen').style.display = 'flex';
    }
  } catch(e) {
    _authInitializing = false;
    console.error('Auth init error:', e);
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('authScreen').style.display = 'flex';
  }
}
initAuth();

// Handle sign in / sign out events (skip during initial session check)
supa.auth.onAuthStateChange(async (event, session) => {
  if (_authInitializing) return;
  if (event === 'SIGNED_IN' && session && session.user && !currentUser) {
    if (window.location.hash.includes('access_token')) {
      setTimeout(() => showToast('Email confirmed ‚Äî welcome to BackProp!', 'success'), 800);
    }
    currentUser = session.user;
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'none';
    await dbLoadProjects();
    document.getElementById('projectListScreen').style.display = 'flex';
    document.getElementById('appShell').style.display = 'none';
    renderProjectList();
  } else if (event === 'SIGNED_OUT') {
    currentUser = null;
    projectStore = [];
    document.getElementById('authScreen').style.display = 'flex';
    document.getElementById('projectListScreen').style.display = 'none';
    document.getElementById('appShell').style.display = 'none';
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MULTI-PROJECT STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Each project stored as: { id, project, levels, props, calcResults }
let projectStore = [];
let activeProjectId = null;

function makeNewProjectData(name, jobNo) {
  const id = 'proj_' + Date.now() + '_' + Math.random().toString(36).slice(2,5);
  return {
    id,
    project: { name: name || 'New Project', jobNo: jobNo || '', prepBy: '', concDensity: 24, maxSpacing: 3.0, props: [] },
    // Always seed with base level at index 0 ‚Äî infinite capacity, not deletable
    levels: [
      { id: 'base_' + id, name: 'Ground', thickness: 0, slabCap: 100000, addLoad: 0, zones: [], isBase: true }
    ],
    calcResults: null,
  };
}

function renderProjectList() {
  const grid = document.getElementById('projGrid');
  grid.innerHTML = '';
  projectStore.forEach(p => {
    const totalZones = p.levels.reduce((a,l) => a + l.zones.length, 0);
    const npCount = p.calcResults ? p.calcResults.filter(r=>r.isNP).length : 0;
    const statusColor = !p.calcResults ? 'var(--text-muted)' : npCount > 0 ? 'var(--np)' : 'var(--tg)';
    const statusTxt = !p.calcResults ? 'Not calculated' : npCount > 0 ? `${npCount} Fail` : 'All pass';
    const card = document.createElement('div');
    card.className = 'proj-card';
    card.innerHTML = `
      <button class="proj-card-del" onclick="event.stopPropagation();deleteProject('${p.id}')" title="Delete project">√ó</button>
      <div class="proj-card-name">${esc(p.project.name)}</div>
      <div class="proj-card-meta">Job No. ${esc(p.project.jobNo || '‚Äî')}${p.project.prepBy ? ' ¬∑ ' + esc(p.project.prepBy) : ''}</div>
      <div class="proj-card-stats">
        <div class="proj-card-stat"><span class="proj-card-stat-val">${p.levels.length}</span>Levels</div>
        <div class="proj-card-stat"><span class="proj-card-stat-val">${totalZones}</span>Zones</div>
        <div class="proj-card-stat"><span class="proj-card-stat-val">${(p.project.props||[]).length}</span>Props</div>
        <div class="proj-card-stat"><span class="proj-card-stat-val" style="color:${statusColor};font-size:11px">${statusTxt}</span>Status</div>
      </div>`;
    card.onclick = () => openProject(p.id);
    grid.appendChild(card);
  });
  const newCard = document.createElement('div');
  newCard.className = 'proj-card proj-card-new';
  newCard.innerHTML = `<div class="proj-new-icon">+</div><div class="proj-new-label">New Project</div>`;
  newCard.onclick = createProject;
  grid.appendChild(newCard);
}

// ‚îÄ‚îÄ Supabase save/load ‚îÄ‚îÄ
let saveTimer = null;
function scheduleSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    const p = projectStore.find(x => x.id === activeProjectId);
    if (p) { saveActiveProject(); dbSaveProject(p); }
  }, 2000);
}

async function dbLoadProjects() {
  if (!currentUser) return;
  const { data, error } = await supa.from('projects').select('*').order('updated_at', { ascending: false });
  if (error) { console.error('Load error:', error); return; }
  projectStore = (data || []).map(row => ({
    id:          row.id,
    _supaId:     row.id,
    project:     { name: row.name, jobNo: row.job_no || '', prepBy: row.prep_by || '', concDensity: 24, maxSpacing: 3.0, props: [], ...(row.data.project || {}) },
    levels:      row.data.levels      || [],
    calcResults: row.data.calcResults || null,
  }));

}

async function dbSaveProject(p) {
  if (!currentUser) return;
  const payload = {
    user_id: currentUser.id,
    name:    p.project.name,
    job_no:  p.project.jobNo  || '',
    prep_by: p.project.prepBy || '',
    data:    { project: p.project, levels: p.levels, calcResults: p.calcResults, props },
  };
  if (p._supaId) {
    const { error } = await supa.from('projects').update(payload).eq('id', p._supaId);
    if (error) console.error('Save error:', error);
    // silent save
  } else {
    const { data, error } = await supa.from('projects').insert(payload).select().single();
    if (error) { console.error('Insert error:', error); return; }
    p._supaId = data.id;
    p.id      = data.id;
    // silent save
  }
}

async function createProject() {
  const name = prompt('Project name:', 'Project ' + (projectStore.length + 1));
  if (name === null) return;
  const jobNo = prompt('Job number (optional):', '');
  if (jobNo === null) return;
  const p = makeNewProjectData(name, jobNo);
  p._supaId = null;
  projectStore.unshift(p);
  await dbSaveProject(p);
  openProject(p.id);
}

function openProject(id) {
  const p = projectStore.find(x => x.id === id);
  if (!p) return;
  if (activeProjectId) saveActiveProject();
  activeProjectId = id;
  project     = p.project;
  levels      = p.levels;
  calcResults = p.calcResults;
  document.getElementById('headerProjName').textContent = project.name;
  document.getElementById('headerJobNo').textContent    = project.jobNo;
  document.getElementById('projectListScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'block';
  showPage('levels');
  updateCalcBtn();
}

function saveActiveProject() {
  const p = projectStore.find(x => x.id === activeProjectId);
  if (p) { p.project = project; p.levels = levels; p.calcResults = calcResults; }
}

function showProjectList() {
  saveActiveProject();
  document.getElementById('appShell').style.display = 'none';
  document.getElementById('projectListScreen').style.display = 'flex';
  renderProjectList();
}

async function deleteProject(id) {
  if (!confirm('Delete this project? This cannot be undone.')) return;
  const p = projectStore.find(x => x.id === id);
  if (p && p._supaId) await supa.from('projects').delete().eq('id', p._supaId);
  projectStore = projectStore.filter(x => x.id !== id);
  if (activeProjectId === id) {
    activeProjectId = null;
    document.getElementById('projectListScreen').style.display = 'flex';
  }
  renderProjectList();
  showToast('Project deleted', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let project = {
  name: 'Project 10354',
  jobNo: '10354',
  prepBy: '',
  concDensity: 24,
  maxSpacing: 3.0,
  props: [],
};

// Levels: bottom to top
// Each level: { id, name, thickness, slabCap, addLoad, zones: [...] }
// Zone: { id, name, thickness, levelsBelow: [{levelId, active, slabCap, addLoad, propId, propSnapshot:{type,capacity}, propCapOverride}] }
// Global working state ‚Äî loaded from projectStore when a project is opened
let levels = [];
// props is USER-LEVEL ‚Äî shared across all projects, not stored per-project
// props is now per-project ‚Äî always access via current project.props
function getProps() { return (project && project.props) ? project.props : []; }
let calcResults = null;
let currentZoneLevelId = null;
let selectedBuilderPour = 0;
let _nextId = 100;
function uid() { return 'id_' + (_nextId++); }

// Base level is always index 0 in the levels array
function isBaseLevel(lev) {
  return levels.indexOf(lev) === 0 || lev.isBase === true;
}
function isBaseLevelById(levelId) {
  const lev = levels.find(l => l.id === levelId);
  return lev ? isBaseLevel(lev) : false;
}

function makeBlEntry(levelId, active, slabCap, addLoad) {
  const propId = getDefaultPropId();
  const libProp = propId ? getProps().find(p => p.id === propId) : null;
  return {
    levelId,
    active,
    slabCap,
    addLoad,
    propId,
    propSnapshot: libProp ? { type: libProp.type, capacity: libProp.capacity } : null,
    propCapOverride: null,
  };
}


function nextZoneName(lev) {
  // Find the highest Zone N number used, suggest next
  let max = 0;
  lev.zones.forEach(z => {
    const m = z.name.match(/^Zone (\d+)$/i);
    if (m) max = Math.max(max, parseInt(m[1]));
  });
  return `Zone ${max + 1}`;
}


function makeDefaultZone(lev, levelIdx) {
  // Build levelsBelow array: levels below this one in reverse (nearest first)
  const below = [];
  for (let j = levelIdx - 1; j >= 0; j--) {
    const depthBelow = levelIdx - 1 - j; // 0 = immediately below, 1 = two levels down, etc.
    below.push(makeBlEntry(
      levels[j].id,
      (levelIdx - j) <= 3,
      levels[j].slabCap,
      depthBelow === 0 ? 0.3 : 0.1
    ));
  }
  return {
    id: 'z_' + lev.id + '_' + Date.now() + '_' + Math.random().toString(36).slice(2,5),
    name: nextZoneName(lev),
    thickness: lev.thickness,
    addLoad: 3.0,
    levelsBelow: below,
  };
}


function updateCalcBtn() {
  const btn = document.getElementById('calcBtn');
  if (!btn) return;
  btn.classList.remove('btn-calc-stale', 'btn-calc-ok');
  if (!calcResults) {
    btn.classList.add('btn-calc-stale');
    btn.textContent = '‚ñ∂ Calculate';
  } else {
    btn.classList.add('btn-calc-ok');
    btn.textContent = '‚úì Calculated';
  }
}

function markDirty() {
  calcResults = null;
  updateCalcBtn();
  scheduleSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  const tab = document.getElementById('tab-' + page);
  if (tab) tab.classList.add('active');

  if (page === 'levels') renderLevels();
  if (page === 'engineer') renderEngineerView();
  if (page === 'builder') renderBuilderView();
  updateSummary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILDING LEVELS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLevels() {
  const body = document.getElementById('levelsBody');
  body.innerHTML = '';
  const total = levels.length;

  // Display top to bottom (roof first, ground last) ‚Äî mirrors physical building
  [...levels].reverse().forEach((lev) => {
    const i = levels.indexOf(lev); // real index in levels array for callbacks
    const isBase = i === 0; // index 0 = base level
    const zoneCount = lev.zones.length;
    const rowNum = levels.length - i; // display number: 1 = highest

    const row = document.createElement('div');
    row.className = `level-row${isBase ? ' is-ground' : ''}`;
    row.innerHTML = `
      <div class="level-badge ${isBase ? 'ground' : ''}">${isBase ? '‚äï' : rowNum}</div>
      <div style="display:flex;align-items:center;gap:8px">
        <input class="row-input name" value="${esc(lev.name)}"
          onchange="updateLevel(${i},'name',this.value)"
          placeholder="e.g. L4">
      </div>
      <div style="display:flex;align-items:center;justify-content:flex-start">
        ${isBase
          ? `<span style="font-size:11px;color:var(--text-dim);font-style:italic">‚Äî Base Level ‚Äî</span>`
          : `<button class="level-zones-btn ${zoneCount > 0 ? 'has-zones' : ''}" onclick="openZones('${lev.id}')">
              ${zoneCount > 0 ? `${zoneCount} zone${zoneCount>1?'s':''} ‚Üí` : 'Add zones ‚Üí'}
            </button>`}
      </div>
      <div style="display:flex;align-items:center;justify-content:center">
        ${!isBase && total > 2 ? `<button class="del-btn" onclick="removeLevel(${i})">√ó</button>` : ''}
      </div>
    `;
    body.appendChild(row);
  });
  updateSummary();
}

function updateLevel(i, key, val) {
  levels[i][key] = val;
  if (key === 'name') renderLevels();
  markDirty();
  updateSummary();
}

function addLevel() {
  const newId = 'lv_' + uid();
  const newLevel = {
    id: newId,
    name: `L${levels.length}`,
    thickness: 230,
    slabCap: 2.5,
    addLoad: 3.0,
    zones: [],
  };
  levels.push(newLevel);
  renderLevels();
  markDirty();
  showToast('Level added', 'success');
}

function removeLevel(i) {
  if (i === 0) return; // base level is protected
  if (levels.length <= 2) return;
  const name = levels[i].name;
  levels.splice(i, 1);
  renderLevels();
  markDirty();
  showToast(`Level ${name} removed`, 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ZONES PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openZones(levelId) {
  currentZoneLevelId = levelId;
  const lev = levels.find(l => l.id === levelId);
  if (!lev) return;

  document.getElementById('zonesBreadcrumbLevel').textContent = lev.name;
  document.getElementById('zonesPageTitle').textContent = `${lev.name} ‚Äî Zones`;

  // Ensure zones have up-to-date levelsBelow
  lev.zones.forEach(zone => refreshZoneLevelsBelow(zone, lev));

  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-zones').classList.add('active');
  renderZones(lev);
}

function refreshZoneLevelsBelow(zone, lev) {
  const levIdx = levels.indexOf(lev);
  // Add any new levels below that don't exist in zone.levelsBelow
  for (let j = levIdx - 1; j >= 0; j--) {
    const blev = levels[j];
    if (!zone.levelsBelow.find(b => b.levelId === blev.id)) {
      const depthBelow = levIdx - 1 - j;
      zone.levelsBelow.push(makeBlEntry(
        blev.id,
        (levIdx - j) <= 3,
        blev.slabCap,
        depthBelow === 0 ? 0.3 : 0.1
      ));
    }
  }
  // Remove deleted levels
  zone.levelsBelow = zone.levelsBelow.filter(b => levels.find(l => l.id === b.levelId));
}

function getDefaultPropId() {
  const p_list = getProps();
  const def = p_list.find(p => p.isDefault);
  return def ? def.id : (p_list.length > 0 ? p_list[0].id : null);
}

function renderZones(lev) {
  const grid = document.getElementById('zonesGrid');
  grid.innerHTML = '';
  const levIdx = levels.indexOf(lev);

  lev.zones.forEach((zone, zi) => {
    const card = document.createElement('div');
    card.className = 'zone-card';

    // Build levels-below table rows
    let levBelowRows = '';
    zone.levelsBelow.forEach((bl, bli) => {
      const blev = levels.find(l => l.id === bl.levelId);
      if (!blev) return;
      const isGnd = isBaseLevel(blev);
      const disabledAttr = bl.active ? '' : 'disabled';

      // Prop selector options
      let propOpts = getProps().length === 0 ? `<option value="">‚Äî add props to library ‚Äî</option>` : "";
      getProps().forEach(p => {
        propOpts += `<option value="${p.id}" ${bl.propId === p.id ? 'selected' : ''}>${p.type} (${p.capacity}kN)</option>`;
      });

      // Prop capacity display
      let propCapVal = bl.propCapOverride !== null ? bl.propCapOverride : getPropCap(bl.propId, bl.propSnapshot);

      levBelowRows += `
        <div class="zone-level-row ${bl.active ? 'checked' : 'disabled'}">
          <input type="checkbox" class="zone-check" ${bl.active ? 'checked' : ''}
            onchange="setZoneLevelActive('${lev.id}',${zi},${bli},this.checked)">
          <div class="zone-lvl-name">${esc(blev.name)}</div>
          ${isGnd
            ? `<div class="zone-lvl-input" style="display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--tg);opacity:${bl.active?1:0.3}">‚àû</div>`
            : `<input class="zone-lvl-input" type="number" value="${bl.slabCap}" step="0.5" ${disabledAttr}
                title="Slab capacity (kPa)"
                onchange="setZoneLevelField('${lev.id}',${zi},${bli},'slabCap',+this.value)">`}
          <input class="zone-lvl-input" type="number" value="${bl.addLoad}" step="0.5" ${disabledAttr}
            title="Additional construction load (kPa)"
            onchange="setZoneLevelField('${lev.id}',${zi},${bli},'addLoad',+this.value)">
          <div class="prop-selector-row" style="${bl.active ? '' : 'opacity:0.3;pointer-events:none'}">
            <select class="prop-select" onchange="setZoneProp('${lev.id}',${zi},${bli},this.value)">
              ${propOpts}
            </select>
          </div>
        </div>
      `;
    });

    card.innerHTML = `
      <div class="zone-card-header">
        <div class="zone-card-title">
          <span>${esc(lev.name)}</span>
          <span style="color:var(--text-muted)">¬∑</span>
          <input style="background:transparent;border:none;border-bottom:1px dashed var(--border);color:var(--accent);font-family:'Syne',sans-serif;font-weight:700;font-size:12px;width:140px;outline:none;padding-bottom:1px"
            value="${esc(zone.name)}"
            title="Click to rename zone"
            onchange="setZoneName('${lev.id}',${zi},this.value)">
          <span class="zone-thickness-badge" id="zoneBadge_${lev.id}_${zi}">${zone.thickness} mm</span>
        </div>
        <button class="del-btn" onclick="removeZone('${lev.id}',${zi})">√ó</button>
      </div>
      <div class="zone-body">
        <div style="display:flex;gap:12px">
          <div class="zone-field" style="flex:1">
            <label>Wet concrete thickness (mm)</label>
            <input class="zone-input" type="number" value="${zone.thickness}" step="10"
              onchange="setZoneThickness('${lev.id}',${zi},+this.value)">
          </div>
          <div class="zone-field" style="flex:1">
            <label>Construction load ‚Äî wet level (kPa)</label>
            <input class="zone-input" type="number" value="${zone.addLoad ?? 3.0}" step="0.1" min="0"
              title="Additional construction load applied at the wet slab level (formwork, equipment, workers)"
              onchange="setZoneAddLoad('${lev.id}',${zi},+this.value)">
          </div>
        </div>

        <div style="margin-top:10px">
          <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px;display:flex;align-items:center;gap:8px">
            LOAD-BEARING LEVELS BELOW
            <span class="chip" style="font-size:9px">‚úì = In Back-Prop Stack</span>
          </div>
          <div class="zone-levels-table">
            <div class="zone-levels-table-header">
              <div class="zone-col-head"></div>
              <div class="zone-col-head">Level</div>
              <div class="zone-col-head">Slab Cap<br><span style="font-weight:400;text-transform:none;font-size:8px">kPa</span></div>
              <div class="zone-col-head">Add Load<br><span style="font-weight:400;text-transform:none;font-size:8px">kPa</span></div>
              <div class="zone-col-head">Prop Selection</div>
            </div>
            ${zone.levelsBelow.length > 0 ? levBelowRows : '<div style="padding:12px;font-size:11px;color:var(--text-muted);text-align:center">No levels below this one</div>'}
          </div>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });

  if (lev.zones.length === 0) {
    grid.innerHTML = `<div class="empty-state" style="height:200px"><div class="empty-icon">üìê</div><div class="empty-text">No zones defined yet</div><div class="empty-hint">Click Add Zone to start</div></div>`;
  }
}


function addZone() {
  const lev = levels.find(l => l.id === currentZoneLevelId);
  if (!lev) return;
  const levIdx = levels.indexOf(lev);
  const newZone = {
    id: 'z_' + uid(),
    name: nextZoneName(lev),
    thickness: lev.thickness,
    addLoad: 3.0,
    levelsBelow: [],
  };
  for (let j = levIdx - 1; j >= 0; j--) {
    const depthBelow = levIdx - 1 - j;
    newZone.levelsBelow.push(makeBlEntry(
      levels[j].id,
      (levIdx - j) <= 3,
      levels[j].slabCap,
      depthBelow === 0 ? 0.3 : 0.1
    ));
  }
  lev.zones.push(newZone);
  renderZones(lev);
  markDirty();
  updateSummary();
}

function removeZone(levId, zi) {
  const lev = levels.find(l => l.id === levId);
  if (!lev) return;
  lev.zones.splice(zi, 1);
  renderZones(lev);
  markDirty();
  updateSummary();
}

function setZoneName(levId, zi, val) {
  const lev = levels.find(l => l.id === levId);
  if (!lev) return;
  lev.zones[zi].name = val;
  markDirty();
}

function setZoneThickness(levId, zi, val) {
  const lev = levels.find(l => l.id === levId);
  if (!lev) return;
  lev.zones[zi].thickness = val;
  const badge = document.getElementById(`zoneBadge_${levId}_${zi}`);
  if (badge) badge.textContent = val + ' mm';
  markDirty();
}

function setZoneAddLoad(levId, zi, val) {
  const lev = levels.find(l => l.id === levId);
  if (!lev) return;
  lev.zones[zi].addLoad = val;
  markDirty();
}

function setZoneLevelActive(levId, zi, bli, checked) {
  const lev = levels.find(l => l.id === levId);
  if (!lev) return;
  lev.zones[zi].levelsBelow[bli].active = checked;
  renderZones(lev);
  markDirty();
}

function setZoneLevelField(levId, zi, bli, field, val) {
  const lev = levels.find(l => l.id === levId);
  if (!lev) return;
  lev.zones[zi].levelsBelow[bli][field] = val;
  markDirty();
}

function setZoneProp(levId, zi, bli, propId) {
  const lev = levels.find(l => l.id === levId);
  if (!lev) return;
  const bl = lev.zones[zi].levelsBelow[bli];
  bl.propId = propId || null;
  bl.propCapOverride = null;
  // Snapshot the prop data at assignment time ‚Äî protects against library edits/deletes
  const libProp = getProps().find(p => p.id === propId);
  bl.propSnapshot = libProp ? { type: libProp.type, capacity: libProp.capacity } : null;
  markDirty();
}

function getPropCap(propId, snapshot) {
  // Always prefer the snapshot ‚Äî protects against library edits/deletes
  if (snapshot && snapshot.capacity != null) return snapshot.capacity;
  if (!propId) return null;
  const p = getProps().find(pr => pr.id === propId);
  return p ? p.capacity : null;
}

// Refresh snapshots in active project when a prop is edited in the library

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROP LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// function renderProps() removed - props now in project settings modal

// function focusPropForm() removed - props now in project settings modal

function saveProp() { saveModalProp(); } // delegates to modal version

function saveModalProp() {
  const type  = document.getElementById('modalPropType').value.trim();
  const ext   = document.getElementById('modalPropExtension').value.trim();
  const cap   = parseFloat(document.getElementById('modalPropCapacity').value);
  const notes = document.getElementById('modalPropNotes').value.trim();
  const editId = document.getElementById('modalPropEditId').value;

  if (!type) { showToast('Enter a prop type', 'error'); return; }
  if (isNaN(cap) || cap <= 0) { showToast('Enter a valid capacity', 'error'); return; }

  if (editId) {
    const idx = getProps().findIndex(p => p.id === editId);
    if (idx >= 0) {
      getProps()[idx] = { ...getProps()[idx], type, extension: ext, capacity: cap, notes };
      showToast('Prop updated', 'success');
    }
  } else {
    const newProp = { id: 'p_' + uid(), type, extension: ext, capacity: cap, notes, isDefault: getProps().length === 0 };
    getProps().push(newProp);
    showToast('Prop added', 'success');
  }
  clearModalPropForm();
  renderModalPropTable();
  reconcilePropIds();
  markDirty();
  // Refresh zone dropdowns if zones page is currently open
  if (currentZoneLevelId) {
    const lev = levels.find(l => l.id === currentZoneLevelId);
    if (lev) renderZones(lev);
  }
}

function showModalPropForm(editIdx) {
  const form = document.getElementById('projModalPropForm');
  form.style.display = 'block';
  clearModalPropForm();
  document.getElementById('projModalPropForm').style.display = 'block';
  if (editIdx !== undefined) {
    const p = getProps()[editIdx];
    document.getElementById('modalPropEditId').value = p.id;
    document.getElementById('modalPropType').value = p.type;
    document.getElementById('modalPropExtension').value = p.extension || '';
    document.getElementById('modalPropCapacity').value = p.capacity;
    document.getElementById('modalPropNotes').value = p.notes || '';
    document.getElementById('modalPropFormTitle').textContent = 'Edit Prop';
  }
  document.getElementById('modalPropType').focus();
}

function clearModalPropForm() {
  document.getElementById('modalPropEditId').value = '';
  document.getElementById('modalPropType').value = '';
  document.getElementById('modalPropExtension').value = '';
  document.getElementById('modalPropCapacity').value = '';
  document.getElementById('modalPropNotes').value = '';
  document.getElementById('modalPropFormTitle').textContent = 'Add Prop';
  document.getElementById('projModalPropForm').style.display = 'none';
}

function renderModalPropTable() {
  const container = document.getElementById('projModalPropTable');
  if (!container) return;
  const propList = getProps();
  if (propList.length === 0) {
    container.innerHTML = '<div style="font-size:11px;color:var(--text-muted);font-family:\'DM Mono\',monospace;padding:4px 0 8px">No props yet ‚Äî add one below.</div>';
    return;
  }
  let html = '<div style="border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:8px">';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 70px 50px 40px;background:var(--surface3);padding:6px 10px;font-size:10px;font-weight:700;letter-spacing:0.5px;color:var(--text-muted);font-family:\'Syne\',sans-serif">';
  html += '<div>TYPE</div><div>EXTENSION</div><div style="text-align:center">kN</div><div></div><div></div></div>';
  propList.forEach((p, i) => {
    html += `<div style="display:grid;grid-template-columns:1fr 1fr 70px 50px 40px;padding:7px 10px;font-size:11px;font-family:'DM Mono',monospace;border-top:1px solid var(--border);align-items:center">`;
    html += `<div style="font-weight:500">${esc(p.type)}</div>`;
    html += `<div style="color:var(--text-muted)">${esc(p.extension||'‚Äî')}</div>`;
    html += `<div style="text-align:center">${p.capacity}</div>`;
    html += `<div style="text-align:center"><button onclick="showModalPropForm(${i})" style="background:none;border:none;color:var(--accent2);cursor:pointer;font-size:11px;font-family:'DM Mono',monospace;padding:0">Edit</button></div>`;
    html += `<div style="text-align:center"><button onclick="removeProp(${i})" style="background:none;border:none;color:var(--np);cursor:pointer;font-size:16px;line-height:1;padding:0">√ó</button></div>`;
    html += '</div>';
  });
  html += '</div>';
  container.innerHTML = html;
}


// function editProp(i) removed - props now in project settings modal

function reconcilePropIds() {
  const validIds = new Set(getProps().map(p => p.id));
  const defaultId = getDefaultPropId();
  levels.forEach(lev => {
    lev.zones.forEach(zone => {
      zone.levelsBelow.forEach(bl => {
        if (bl.propId && !validIds.has(bl.propId)) {
          // Prop deleted from library ‚Äî snapshot preserves calc data, just clear stale ID
          if (bl.propSnapshot) {
            bl.propId = null;
          } else {
            // No snapshot (legacy) ‚Äî reassign to default
            bl.propId = defaultId;
            bl.propCapOverride = null;
          }
        }
        // Only assign default if there is truly nothing ‚Äî no ID and no snapshot
        if (!bl.propId && !bl.propSnapshot && defaultId) {
          bl.propId = defaultId;
          const libProp = getProps().find(p => p.id === defaultId);
          if (libProp) bl.propSnapshot = { type: libProp.type, capacity: libProp.capacity };
        }
      });
    });
  });
  markDirty();
}

function removeProp(i) {
  getProps().splice(i, 1);
  reconcilePropIds();
  renderModalPropTable();
  showToast('Prop removed', 'info');
  if (currentZoneLevelId) {
    const lev = levels.find(l => l.id === currentZoneLevelId);
    if (lev) renderZones(lev);
  }
}

// function clearPropForm() removed - props now in project settings modal

function togglePropDefault(i) {
  getProps().forEach((p, j) => p.isDefault = (j === i && !p.isDefault));
  renderProps();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CALCULATION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runCalc() {
  const density = project.concDensity;
  const maxSp = project.maxSpacing;
  const results = [];

  // ‚îÄ‚îÄ PRE-FLIGHT VALIDATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const validPropIds = new Set(getProps().map(p => p.id));

  // Check 1: skip ‚Äî prop library can be empty if zones have snapshots or overrides
  // (check 2 below catches any zones truly missing a prop)

  // Check 2: every active levelsBelow entry must have a usable prop
  // A prop is usable if: propCapOverride set, OR propId in library, OR propSnapshot exists
  const missingPropZones = [];
  levels.forEach(lev => {
    if (isBaseLevel(lev)) return;
    lev.zones.forEach(zone => {
      zone.levelsBelow.forEach(bl => {
        if (!bl.active) return;
        const hasOverride = bl.propCapOverride !== null && bl.propCapOverride !== undefined;
        const hasLibProp  = bl.propId && validPropIds.has(bl.propId);
        const hasSnapshot = bl.propSnapshot && bl.propSnapshot.capacity > 0;
        if (!hasOverride && !hasLibProp && !hasSnapshot) {
          missingPropZones.push(`${lev.name} ¬∑ ${zone.name}`);
        }
      });
    });
  });

  if (missingPropZones.length > 0) {
    const unique = [...new Set(missingPropZones)];
    showToast(
      `Cannot calculate ‚Äî no prop assigned in: ${unique.join(', ')}. Open each zone and select a prop for all active levels.`,
      'error'
    );
    return;
  }

  // Check 3: at least one level with zones must exist
  const levelsWithZones = levels.filter(l => !isBaseLevel(l) && l.zones.length > 0);
  if (levelsWithZones.length === 0) {
    showToast('Cannot calculate ‚Äî no zones defined. Add zones to at least one level first.', 'error');
    return;
  }
  // ‚îÄ‚îÄ END PRE-FLIGHT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // For each level (non-ground), for each zone
  levels.forEach((lev, li) => {
    if (isBaseLevel(lev)) return; // skip base level
    if (lev.zones.length === 0) return;

    lev.zones.forEach(zone => {
      const thickM = zone.thickness / 1000;
      const slabLoad = thickM * density;
      const addLoad = zone.addLoad ?? lev.addLoad ?? 3.0;
      const totalWetLoad = slabLoad + addLoad;

      const pourResult = {
        levelId: lev.id,
        zoneId: zone.id,
        levelName: lev.name,
        zoneName: zone.name,
        label: `${lev.name} ¬∑ ${zone.name}`,
        thickness: zone.thickness,
        slabLoad,
        totalLoad: totalWetLoad,
        levels: [],
        maxSpacingAchieved: null,
        isNP: false,
        isTG: false,
      };

      // ‚îÄ‚îÄ BACK-PROPPING LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      //
      // Two distinct cases:
      //
      // CASE A ‚Äî Props resolve to GROUND (T/G):
      //   The full wet load is carried by props all the way down to the ground
      //   slab. Intermediate slabs do NOT absorb any load ‚Äî they simply transfer
      //   the full wet load downward. Every back-propped level in the stack must
      //   have props sized for the FULL wet load.
      //
      // CASE B ‚Äî Props do NOT reach ground:
      //   Each active slab absorbs its stated capacity, reducing the cumulative
      //   load. If all load is absorbed before the bottom of the stack ‚Üí OK.
      //   If there is any remainder after the last active level ‚Üí FAIL (N/P).
      //   No prop spacing result is possible ‚Äî user must add more load-bearing
      //   levels or increase slab capacity.
      //
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      const activeBelowEntries = zone.levelsBelow.filter(b => b.active);

      if (activeBelowEntries.length === 0) {
        pourResult.isNP = true;
        pourResult.failReason = 'No load-bearing levels selected.';
      } else {
        // Determine if stack reaches ground
        const reachesGround = activeBelowEntries.some(b => {
          const bl = levels.find(l => l.id === b.levelId);
          return bl && isBaseLevel(bl);
        });

        if (reachesGround) {
          // ‚îÄ‚îÄ CASE A: T/G ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          // Every level in the stack (including intermediates) props the FULL
          // wet load. Ground slab is recorded as T/G with no prop spacing.
          pourResult.isTG = true;

          activeBelowEntries.forEach(bl => {
            const blev = levels.find(l => l.id === bl.levelId);
            if (!blev) return;
            const isGndLevel = isBaseLevel(blev);

            // For base level AND intermediate levels in T/G case:
            // props carry the FULL wet load. Compute spacing based on prop cap.
            const propCapKN = bl.propCapOverride !== null ? bl.propCapOverride : getPropCap(bl.propId, bl.propSnapshot);
            if (!propCapKN) { pourResult.isNP = true; pourResult.failReason = `No prop capacity set at ${blev.name}. Assign a prop in zone settings.`; return; }
            const propSpacing = Math.sqrt(propCapKN / totalWetLoad);
            const cappedSpacing = Math.min(propSpacing, maxSp);
            const status = cappedSpacing > 0 ? cappedSpacing.toFixed(2) + 'm' : 'Fail';
            if (status === 'Fail') pourResult.isNP = true;

            pourResult.levels.push({
              name: blev.name,
              isGround: isGndLevel,
              cumulativeLoad: totalWetLoad,
              capacity: isGndLevel ? null : bl.slabCap,
              propCap: propCapKN,
              netLoad: isGndLevel ? 0 : totalWetLoad,
              status,
              propSpacing: cappedSpacing > 0 ? cappedSpacing : null,
              propId: bl.propId,
            });
          });

        } else {
          // ‚îÄ‚îÄ CASE B: Distributed across load-bearing slabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          // Each slab absorbs its stated capacity. Any remainder after the last
          // slab = FAIL (no prop spacing result possible).
          let cumLoad = totalWetLoad;

          activeBelowEntries.forEach(bl => {
            const blev = levels.find(l => l.id === bl.levelId);
            if (!blev) return;

            const propCapKN = bl.propCapOverride !== null ? bl.propCapOverride : getPropCap(bl.propId, bl.propSnapshot);
            if (!propCapKN) { pourResult.isNP = true; pourResult.failReason = `No prop capacity set at ${blev.name}. Assign a prop in zone settings.`; return; }
            let propSpacing = null;
            let status = '';

            if (cumLoad > 0) {
              const rawSpacing = Math.sqrt(propCapKN / cumLoad);
              propSpacing = Math.min(rawSpacing, maxSp);
              status = propSpacing > 0 ? propSpacing.toFixed(2) + 'm' : 'Fail';
              if (propSpacing <= 0) pourResult.isNP = true;
            } else {
              // Load already fully absorbed higher up
              status = 'no load';
              propSpacing = null;
            }

            pourResult.levels.push({
              name: blev.name,
              isGround: false,
              cumulativeLoad: cumLoad,
              capacity: bl.slabCap,
              propCap: propCapKN,
              netLoad: Math.max(0, cumLoad - bl.slabCap),
              status,
              propSpacing,
              propId: bl.propId,
            });

            cumLoad = Math.max(0, cumLoad - bl.slabCap);
          });

          // Check for remainder ‚Äî any load not absorbed = FAIL
          if (cumLoad > 0.01) {
            pourResult.isNP = true;
            pourResult.isTG = false;
            pourResult.failReason = `Load not fully resolved ‚Äî ${cumLoad.toFixed(2)} kPa remaining after the last load-bearing level. Add more load-bearing levels or increase slab capacity.`;
            // Clear all prop spacings ‚Äî no result is valid
            pourResult.levels.forEach(l => {
              l.status = 'Fail';
              l.propSpacing = null;
            });
          } else {
            pourResult.isTG = false; // resolved through slabs, not ground
          }
        }
      }

      const spacings = pourResult.levels
        .filter(l => l.propSpacing !== null && l.propSpacing > 0)
        .map(l => l.propSpacing);
      pourResult.maxSpacingAchieved = (!pourResult.isNP && spacings.length > 0) ? Math.min(...spacings) : null;
      pourResult.isNP = pourResult.isNP || pourResult.levels.some(l => l.status === 'Fail');

      results.push(pourResult);
    });
  });

  calcResults = results;
  renderEngineerView();
  renderBuilderView();
  showToast(`Calculation complete ‚Äî ${results.length} pour scenario${results.length !== 1 ? 's' : ''} ¬∑ saved`, 'success');
  updateSummary();
  updateCalcBtn();
  // Save results to database
  const activeP = projectStore.find(x => x.id === activeProjectId);
  if (activeP) { saveActiveProject(); dbSaveProject(activeP); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENGINEER VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEngineerView() {
  document.getElementById('engProjName').textContent = project.name;
  document.getElementById('engJobNo').textContent = 'Job No. ' + project.jobNo;
  document.getElementById('engDensity').value = project.concDensity;
  document.getElementById('engSpacing').value = project.maxSpacing;

  if (!calcResults || calcResults.length === 0) {
    document.getElementById('engineerMain').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚öô</div>
        <div class="empty-text">Configure levels & zones, then click Calculate</div>
        <div class="empty-hint">Results will appear here</div>
      </div>`;
    document.getElementById('engPoursBody').innerHTML = `<div style="font-size:11px;color:var(--text-muted)">No results yet</div>`;
    return;
  }

  // Guard: if results reference levels that no longer exist, treat as stale
  const currentLevelNamesEng = new Set(levels.map(l => l.name));
  if (calcResults.some(r => !currentLevelNamesEng.has(r.levelName))) {
    calcResults = null;
    updateCalcBtn();
    document.getElementById('engineerMain').innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Project changed</div><div class="empty-hint">Click Calculate to update results</div></div>`;
    document.getElementById('engPoursBody').innerHTML = `<div style="font-size:11px;color:var(--text-muted)">Recalculate needed</div>`;
    return;
  }

  // Sidebar pour list ‚Äî Pass/Fail only, clickable links to edit zone
  let poursHtml = '';
  [...calcResults].reverse().forEach((r) => {
    const pass = !r.isNP;
    const cl = pass ? 'var(--tg)' : 'var(--np)';
    const badge = pass ? 'PASS' : 'FAIL';
    // Find the level id so we can navigate to its zones page
    const lev = levels.find(l => l.name === r.levelName);
    const levId = lev ? lev.id : null;
    const linkAttr = levId ? `onclick="showPage('levels');openZones('${levId}')" style="cursor:pointer"` : '';
    poursHtml += `
      <div class="sidebar-pour-item" ${linkAttr} title="${levId ? 'Click to edit zones for ' + esc(r.levelName) : ''}">
        <span style="flex:1">${esc(r.label)}</span>
        <span style="color:${cl};font-weight:600;font-size:10px;flex-shrink:0">${badge}</span>
        ${levId ? `<span style="color:var(--text-dim);font-size:9px;flex-shrink:0;margin-left:4px">‚úé</span>` : ''}
      </div>`;
  });
  document.getElementById('engPoursBody').innerHTML = poursHtml || `<div style="font-size:11px;color:var(--text-muted)">No results</div>`;

  // Status bar
  const npCount = calcResults.filter(r => r.isNP).length;
  const tgCount = calcResults.filter(r => r.isTG && !r.isNP).length;

  // Build all level names that appear below any pour
  const allBelowNames = [];
  levels.forEach(l => { if (!allBelowNames.includes(l.name)) allBelowNames.push(l.name); });

  // helper: get prop label for a zone/level entry
  function getPropLabel(r, levelName) {
    const lev = levels.find(l => l.id === r.levelId);
    if (!lev) return '‚Äî';
    const zone = r.zoneId ? lev.zones.find(z => z.id === r.zoneId) : lev.zones.find(z => z.name === r.zoneName);
    if (!zone) return '‚Äî';
    const bl = zone.levelsBelow.find(b => {
      const bl2 = levels.find(l => l.id === b.levelId);
      return bl2 && bl2.name === levelName;
    });
    if (!bl || !bl.active) return '‚Äî';
    // Use snapshot type first, fall back to library
    if (bl.propSnapshot) return bl.propSnapshot.type;
    const prop = getProps().find(p => p.id === bl.propId);
    return prop ? prop.type : '‚Äî';
  }

  // helper: get slab capacity for a zone/level entry
  function getSlabCap(r, levelName) {
    const entry = r.levels.find(l => l.name === levelName);
    return entry ? entry.capacity : null;
  }

  const rowNames = [...new Set(levels.map(l=>l.name))].reverse();

  // shared column headers
  const colHeaders = calcResults.map(r => {
    const lev = levels.find(l => l.name === r.levelName);
    const levId = lev ? lev.id : null;
    const linkStart = levId ? `<a onclick="showPage('levels');openZones('${levId}')" style="cursor:pointer;color:var(--accent);text-decoration:none" title="Edit zones for ${esc(r.levelName)}">` : '<span>';
    const linkEnd = levId ? '</a>' : '</span>';
    return `<th class="col-pour">${linkStart}${esc(r.levelName)}<br><span style="font-weight:400;font-size:9px;color:var(--text-muted)">${esc(r.zoneName)}</span>${linkEnd}</th>`;
  }).join('');

  // ‚îÄ‚îÄ Matrices side-by-side wrapper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let matHtml = `<div style="display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start">`;

  // ‚îÄ‚îÄ 1. Prop Spacing Matrix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  matHtml += `<div style="flex:1;min-width:300px">
    <div class="results-title">Prop Spacing <span class="tag">m c/c</span></div>
    <div class="results-sub">Min spacing at each back-prop level. Green = OK, Orange = tight (&lt;1.2m), Red = Fail</div>
    <div class="matrix-container">
      <table class="matrix-table"><thead><tr><th>Level</th>${colHeaders}</tr></thead><tbody>`;

  rowNames.forEach(levelName => {
    matHtml += `<tr><td class="row-label">${esc(levelName)}</td>`;
    calcResults.forEach(r => {
      if (r.levelName === levelName) { matHtml += `<td class="cell-wet">WET</td>`; return; }
      const entry = r.levels.find(l => l.name === levelName);
      if (!entry) { matHtml += `<td class="cell-empty">‚Äî</td>`; return; }
      if (entry.status === 'Fail' || r.isNP) { matHtml += `<td class="cell-np">Fail</td>`; return; }
      const sp = entry.propSpacing;
      const cls = !sp ? 'cell-empty' : sp < 1.2 ? 'cell-warn' : 'cell-ok';
      matHtml += `<td class="${cls}">${sp ? sp.toFixed(2) : '‚Äî'}</td>`;
    });
    matHtml += `</tr>`;
  });
  matHtml += `</tbody></table></div></div>`;

  // ‚îÄ‚îÄ 2. Prop Type Matrix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  matHtml += `<div style="flex:1;min-width:300px">
    <div class="results-title">Prop Type <span class="tag">LIBRARY</span></div>
    <div class="results-sub">Prop selected at each back-prop level for each pour/zone</div>
    <div class="matrix-container">
      <table class="matrix-table"><thead><tr><th>Level</th>${colHeaders}</tr></thead><tbody>`;

  rowNames.forEach(levelName => {
    matHtml += `<tr><td class="row-label">${esc(levelName)}</td>`;
    calcResults.forEach(r => {
      if (r.levelName === levelName) { matHtml += `<td class="cell-wet">WET</td>`; return; }
      const entry = r.levels.find(l => l.name === levelName);
      if (!entry) { matHtml += `<td class="cell-empty">‚Äî</td>`; return; }
      const label = getPropLabel(r, levelName);
      const cls = label === '‚Äî' ? 'cell-empty' : 'cell-ok';
      matHtml += `<td class="${cls}" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:10px" title="${esc(label)}">${esc(label)}</td>`;
    });
    matHtml += `</tr>`;
  });
  matHtml += `</tbody></table></div></div>`;

  matHtml += `</div>`; // end side-by-side row 1

  // ‚îÄ‚îÄ Second row: Cumulative Load + Slab Capacity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  matHtml += `<div style="display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start;margin-top:20px">`;

  // ‚îÄ‚îÄ 3. Cumulative Load Matrix (with red for fail) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  matHtml += `<div style="flex:1;min-width:300px">
    <div class="results-title">Cumulative Load <span class="tag">kPa</span></div>
    <div class="results-sub">Cumulative wet load at each level. Red = unresolved load (Fail)</div>
    <div class="matrix-container">
      <table class="matrix-table"><thead><tr><th>Level</th>${colHeaders}</tr></thead><tbody>`;

  rowNames.forEach(levelName => {
    matHtml += `<tr><td class="row-label">${esc(levelName)}</td>`;
    calcResults.forEach(r => {
      if (r.levelName === levelName) { matHtml += `<td class="cell-wet">${r.totalLoad.toFixed(2)}</td>`; return; }
      const entry = r.levels.find(l => l.name === levelName);
      if (!entry) { matHtml += `<td class="cell-empty">‚Äî</td>`; return; }
      const load = entry.cumulativeLoad;
      let cls;
      if (r.isNP) {
        cls = 'cell-np';
      } else if (load <= 0) {
        cls = 'cell-tg';
      } else if (load > r.totalLoad * 0.8) {
        cls = 'cell-warn';
      } else {
        cls = 'cell-ok';
      }
      matHtml += `<td class="${cls}">${load.toFixed(2)}</td>`;
    });
    matHtml += `</tr>`;
  });
  matHtml += `</tbody></table></div></div>`;

  // ‚îÄ‚îÄ 4. Slab Capacity Matrix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  matHtml += `<div style="flex:1;min-width:300px">
    <div class="results-title">Slab Capacity <span class="tag">kPa</span></div>
    <div class="results-sub">Slab capacity at each back-prop level for each pour/zone</div>
    <div class="matrix-container">
      <table class="matrix-table"><thead><tr><th>Level</th>${colHeaders}</tr></thead><tbody>`;

  rowNames.forEach(levelName => {
    const isBaseRow = levels.length > 0 && levels[0].name === levelName;
    matHtml += `<tr><td class="row-label">${esc(levelName)}</td>`;
    calcResults.forEach(r => {
      if (r.levelName === levelName) { matHtml += `<td class="cell-wet">WET</td>`; return; }
      const entry = r.levels.find(l => l.name === levelName);
      if (!entry) { matHtml += `<td class="cell-empty">‚Äî</td>`; return; }
      // Base level: show ‚àû symbol since it has effectively infinite capacity
      if (isBaseRow) { matHtml += `<td class="cell-tg" style="font-size:13px">‚àû</td>`; return; }
      const cap = entry.capacity;
      const cls = cap === null ? 'cell-empty' : 'cell-ok';
      matHtml += `<td class="${cls}">${cap !== null ? cap.toFixed(2) : '‚Äî'}</td>`;
    });
    matHtml += `</tr>`;
  });
  matHtml += `</tbody></table></div></div>`;

  matHtml += `</div>`; // end side-by-side row 2

  // ‚îÄ‚îÄ Pour Scenario Detail cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  matHtml += `<div class="results-title" style="margin-top:20px">Pour Scenario Detail</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">`;

  calcResults.forEach(r => {
    const statusCls = r.isNP ? 'fail' : 'pass';
    const statusTxt = r.isNP ? 'FAIL' : 'PASS';
    const resolutionColour = r.isNP ? 'var(--np)' : 'var(--tg)';
    const resolutionLabel = r.isNP ? 'Fail' : 'Pass';
    matHtml += `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden">
        <div style="background:var(--surface2);padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
          <span style="font-family:'Syne',sans-serif;font-size:12px;font-weight:700">${esc(r.label)}</span>
          <span class="pass-badge ${statusCls}">${statusTxt}</span>
        </div>
        <div style="padding:12px 14px">
          <div class="info-row"><span class="info-key">Thickness</span><span class="info-val">${r.thickness} mm</span></div>
          <div class="info-row"><span class="info-key">Slab self-weight</span><span class="info-val">${r.slabLoad.toFixed(2)} kPa</span></div>
          <div class="info-row"><span class="info-key">Total wet load</span><span class="info-val">${r.totalLoad.toFixed(2)} kPa</span></div>
          <div class="info-row"><span class="info-key">Back-prop levels</span><span class="info-val">${r.levels.length}</span></div>
          <div class="info-row"><span class="info-key">Resolution</span><span class="info-val" style="color:${resolutionColour};font-weight:600">${resolutionLabel}</span></div>
          ${r.isNP ? `<div style="margin-top:8px;padding:8px;background:rgba(240,80,80,0.08);border:1px solid rgba(240,80,80,0.2);border-radius:5px;color:var(--np);font-size:10px">‚ö† ${r.failReason || 'Review back-propping arrangement.'}</div>` : ''}
        </div>
      </div>`;
  });

  matHtml += `</div>`;
  document.getElementById('engineerMain').innerHTML = matHtml;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILDER VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBuilderView() {
  if (!calcResults || calcResults.length === 0) {
    document.getElementById('builderPourList').innerHTML = `<div style="font-size:11px;color:var(--text-muted)">No results ‚Äî click Calculate first</div>`;
    document.getElementById('builderContent').innerHTML = `<div class="empty-state"><div class="empty-icon">üë∑</div><div class="empty-text">Calculate first</div></div>`;
    return;
  }

  // Guard: if any result references a level that no longer exists, results are stale
  const currentLevelNames = new Set(levels.map(l => l.name));
  const isStale = calcResults.some(r => !currentLevelNames.has(r.levelName));
  if (isStale) {
    calcResults = null;
    updateCalcBtn();
    document.getElementById('builderPourList').innerHTML = `<div style="font-size:11px;color:var(--text-muted)">Levels changed ‚Äî recalculate</div>`;
    document.getElementById('builderContent').innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Project changed</div><div class="empty-hint">Click Calculate to update results</div></div>`;
    return;
  }

  // Pour list ‚Äî reversed so highest level pours appear first (top of building down)
  const listEl = document.getElementById('builderPourList');
  listEl.innerHTML = '';
  [...calcResults].reverse().forEach((r, revIdx) => {
    const i = calcResults.length - 1 - revIdx; // real index for selection
    const item = document.createElement('div');
    item.className = `pour-item${i === selectedBuilderPour ? ' active' : ''}`;
    const passColour = r.isNP ? 'var(--np)' : 'var(--tg)';
    const passTxt = r.isNP ? 'Fail' : 'Pass';
    item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div class="pour-item-name">${esc(r.label)}</div>
      <span style="color:${passColour};font-size:10px;font-weight:600">${passTxt}</span></div>
      <div class="pour-item-sub">${r.thickness}mm ¬∑ ${r.totalLoad.toFixed(1)} kPa</div>`;
    item.onclick = () => { selectedBuilderPour = i; renderBuilderView(); };
    listEl.appendChild(item);
  });

  renderBuilderVis(calcResults[selectedBuilderPour]);
}

function renderBuilderVis(pour) {
  if (!pour) return;
  const content = document.getElementById('builderContent');

  // Build level visualisation (top to bottom display)
  const levelsTopDown = [...levels].reverse();
  const activeNames = new Set([pour.levelName, ...pour.levels.map(l=>l.name)]);

  let visHtml = `<div class="building-vis-wrap">
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:14px;color:var(--text-muted)">
      Back-propping arrangement for <span style="color:var(--text)">${esc(pour.label)}</span>
    </div>
    <div class="builder-legend">
      <div class="legend-item"><div class="legend-swatch" style="color:var(--wet);background:rgba(77,168,255,0.2)"></div>Wet pour (active)</div>
      <div class="legend-item"><div class="legend-swatch" style="color:var(--tg);background:rgba(56,201,110,0.2)"></div>Back-propped</div>
      <div class="legend-item"><div class="legend-swatch" style="color:var(--warn);background:rgba(212,146,26,0.2)"></div>Tight (&lt;1.2m)</div>
      <div class="legend-item"><div class="legend-swatch" style="color:var(--np);background:rgba(240,80,80,0.2)"></div>Fail</div>
      <div class="legend-item"><div class="legend-swatch" style="color:var(--border);background:var(--surface2)"></div>Not involved</div>
    </div>`;

  levelsTopDown.forEach((lev, idx) => {
    const isCurrent = lev.name === pour.levelName;
    const entry = pour.levels.find(l => l.name === lev.name);

    let barClass = 'slab-neutral';
    let barText = lev.name;

    if (isCurrent) {
      barClass = 'slab-wet';
      barText = `${lev.name} ‚Äî WET POUR (${pour.thickness}mm)`;
    } else if (entry) {
      const sp = entry.propSpacing;
      // Get prop name for this entry
      const propObj = entry.propId ? getProps().find(p => p.id === entry.propId) : null;
      const propName = propObj ? propObj.type : '‚Äî';
      const spText = sp ? `${sp.toFixed(2)}m` : '‚Äî';
      const detailSuffix = (propName !== '‚Äî' || sp) ? ` ‚Äî ${propName} @ ${spText}` : '';

      if (entry.status === 'Fail') {
        barClass = 'slab-np';
        barText = `${lev.name} ‚Äî Fail`;
      } else if (sp && sp < 1.2) {
        barClass = 'slab-warn';
        barText = `${lev.name}${detailSuffix}`;
      } else if (sp) {
        barClass = 'slab-ok';
        barText = `${lev.name}${detailSuffix}`;
      }
    }

    visHtml += `<div class="vis-level">
      <div class="vis-label">${esc(lev.name)}</div>
      <div class="vis-bar ${barClass}">${barText}</div>
    </div>`;

    // Prop lines between active back-prop levels
    if (entry && !isCurrent && entry.propSpacing) {
      const propCount = Math.min(12, Math.floor(3.0 / entry.propSpacing) + 2);
      visHtml += `<div class="vis-props">`;
      for (let p = 0; p < propCount; p++) visHtml += `<div class="vis-prop-line" style="height:${8+p%4*2}px"></div>`;
      visHtml += `</div>`;
    }
  });

  visHtml += `</div>`;

  // Summary ‚Äî 9. Pass/Fail only, no governing prop spacing
  const statusCls = pour.isNP ? 'fail' : 'pass';
  const statusTxt = pour.isNP ? 'FAIL' : 'PASS';

  visHtml += `<div class="summary-panel">
    <div class="summary-panel-header">
      ${esc(pour.label)}
      <span class="pass-badge ${statusCls}">${statusTxt}</span>
    </div>
    <div class="summary-body">
      <div class="info-row"><span class="info-key">Wet thickness</span><span class="info-val">${pour.thickness} mm</span></div>
      <div class="info-row"><span class="info-key">Slab self-weight</span><span class="info-val">${pour.slabLoad.toFixed(2)} kPa</span></div>
      <div class="info-row"><span class="info-key">Total construction load</span><span class="info-val">${pour.totalLoad.toFixed(2)} kPa</span></div>
      <div class="info-row"><span class="info-key">Back-prop stack depth</span><span class="info-val">${pour.levels.length} level${pour.levels.length !== 1 ? 's' : ''}</span></div>
      ${pour.isNP ? `<div style="margin-top:10px;padding:10px;background:rgba(240,80,80,0.08);border:1px solid rgba(240,80,80,0.2);border-radius:6px;color:var(--np);font-size:11px">‚ö† ${pour.failReason || 'Fail ‚Äî review back-propping arrangement before proceeding.'}</div>` : ''}
    </div>
  </div>`;

  content.innerHTML = visHtml;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROJECT SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProjModal() {
  renderModalPropTable();
  clearModalPropForm();
  document.getElementById('projName').value = project.name;
  document.getElementById('jobNo').value = project.jobNo;
  document.getElementById('prepBy').value = project.prepBy;
  document.getElementById('concDensity').value = project.concDensity;
  document.getElementById('maxSpacing').value = project.maxSpacing;
  document.getElementById('projModal').classList.add('open');
}

function closeProjModal() {
  document.getElementById('projModal').classList.remove('open');
}

function saveProjSettings() {
  project.name = document.getElementById('projName').value;
  project.jobNo = document.getElementById('jobNo').value;
  project.prepBy = document.getElementById('prepBy').value;
  project.concDensity = +document.getElementById('concDensity').value;
  project.maxSpacing = +document.getElementById('maxSpacing').value;
  // Sync sidebar inputs
  if (document.getElementById('engDensity')) document.getElementById('engDensity').value = project.concDensity;
  if (document.getElementById('engSpacing')) document.getElementById('engSpacing').value = project.maxSpacing;
  document.getElementById('headerProjName').textContent = project.name;
  document.getElementById('headerJobNo').textContent = project.jobNo;
  calcResults = null;
  markDirty();
  closeProjModal();
  // Refresh zone dropdowns in case props changed
  if (currentZoneLevelId) {
    const lev = levels.find(l => l.id === currentZoneLevelId);
    if (lev) renderZones(lev);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSummary() {
  const totalZones = levels.reduce((a,l) => a + l.zones.length, 0);
  document.getElementById('sumLevels').textContent = levels.length;
  document.getElementById('sumZones').textContent = totalZones;
  document.getElementById('sumProps').textContent = getProps().length;
  if (!calcResults) {
    document.getElementById('sumStatus').innerHTML = `<span class="chip chip-warn">Not calculated</span>`;
  } else {
    const np = calcResults.filter(r=>r.isNP).length;
    if (np > 0) {
      document.getElementById('sumStatus').innerHTML = `<span class="chip" style="background:rgba(240,80,80,0.1);color:var(--np);border-color:rgba(240,80,80,0.2)">${np} Fail</span>`;
    } else {
      document.getElementById('sumStatus').innerHTML = `<span class="chip chip-green">All pass</span>`;
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openImport() { document.getElementById('importModal').classList.add('open'); }
function closeImport() { document.getElementById('importModal').classList.remove('open'); }

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) processFile(file);
}

function processFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const thkSheet = wb.Sheets['THICKNESS'];
      const capSheet = wb.Sheets['CAPACITY'];

      if (!thkSheet) {
        showToast('No THICKNESS sheet found', 'error');
        closeImport(); return;
      }

      const thkData = XLSX.utils.sheet_to_json(thkSheet, { header: 1, defval: null });
      const capData = capSheet ? XLSX.utils.sheet_to_json(capSheet, { header: 1, defval: null }) : null;

      const thicknesses = {}, capacities = {};
      const headerRow = thkData[0] || [];

      thkData.slice(2).forEach(row => {
        const name = String(row[0] || '').trim();
        if (!name || name === 'LEVEL' || name === 'TYPE') return;
        const colIdx = headerRow.findIndex(h => h && String(h).trim() === name);
        if (colIdx >= 0 && row[colIdx] && row[colIdx] !== 'F/W') {
          thicknesses[name] = Number(row[colIdx]);
        } else {
          for (let c = 1; c < row.length; c++) {
            if (row[c] !== null && row[c] !== 'F/W' && !isNaN(Number(row[c]))) {
              thicknesses[name] = Number(row[c]); break;
            }
          }
        }
      });

      if (capData) {
        capData.slice(2).forEach(row => {
          const name = String(row[0] || '').trim();
          if (!name) return;
          const colIdx = (capData[0] || []).findIndex(h => h && String(h).trim() === name);
          if (colIdx >= 0 && row[colIdx] && row[colIdx] !== 'WET') {
            capacities[name] = Number(row[colIdx]);
          } else {
            for (let c = 1; c < row.length; c++) {
              if (row[c] !== null && row[c] !== 'WET' && !isNaN(Number(row[c]))) {
                capacities[name] = Number(row[c]); break;
              }
            }
          }
        });
      }

      const rowLabels = thkData.slice(2).map(r => String(r[0] || '').trim()).filter(Boolean);
      const orderedNames = [...new Set(rowLabels)].reverse();

      levels = orderedNames.map((name, i) => {
        const isGnd = name === levels[0]?.name || name.toUpperCase() === 'G';
        const thk = thicknesses[name] || (isGnd ? 300 : 230);
        const cap = capacities[name] || (isGnd ? 20 : 2.5);
        return {
          id: 'lv_' + uid(),
          name, thickness: thk, slabCap: cap, addLoad: 3.0, zones: [],
        };
      });

      // Create default zones
      levels.forEach((lev, i) => {
        if (!isBaseLevel(lev)) {
          lev.zones = [makeDefaultZone(lev, i)];
        }
      });

      renderLevels();
      calcResults = null;
      showToast(`Imported ${levels.length} levels from XLSX`, 'success');
      closeImport();

    } catch (err) {
      showToast('Error reading file: ' + err.message, 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportResults() {
  if (!calcResults || calcResults.length === 0) {
    showToast('Run calculation first', 'error'); return;
  }
  const wb = XLSX.utils.book_new();

  // Summary
  const pourLabels = calcResults.map(r => r.label);
  const rowNames = [...new Set(levels.map(l=>l.name))].reverse();

  const summaryData = [['Level / Zone', ...pourLabels]];
  rowNames.forEach(n => {
    const row = [n];
    calcResults.forEach(r => {
      if (r.levelName === n) { row.push('WET'); return; }
      const e = r.levels.find(l=>l.name===n);
      row.push(e ? e.status : '');
    });
    summaryData.push(row);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'SUMMARY');

  // Detail
  const detailData = [['Zone', 'Thickness mm', 'Slab Load kPa', 'Total Load kPa', 'Gov Spacing', 'To Ground', 'Fail']];
  calcResults.forEach(r => {
    detailData.push([
      r.label, r.thickness,
      r.slabLoad.toFixed(2), r.totalLoad.toFixed(2),
      r.maxSpacingAchieved ? r.maxSpacingAchieved.toFixed(2)+'m' : (r.isNP?'Fail':'To Ground'),
      r.isTG?'YES':'NO', r.isNP?'YES':'NO',
    ]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(detailData), 'DETAIL');

  // Prop library
  const propData = [['Type', 'Extension', 'Capacity kN', 'Notes', 'Default']];
  getProps().forEach(p => propData.push([p.type, p.extension, p.capacity, p.notes, p.isDefault?'YES':'NO']));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(propData), 'PROP LIBRARY');

  XLSX.writeFile(wb, `${project.jobNo}_backpropping.xlsx`);
  showToast('Exported to XLSX', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s) {
  return String(s || '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

function showToast(msg, type = 'success', duration = 5000) {
  const container = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  container.appendChild(t);
  // Animate in
  requestAnimationFrame(() => requestAnimationFrame(() => t.classList.add('show')));
  // Animate out then remove
  setTimeout(() => {
    t.classList.remove('show');
    t.classList.add('hiding');
    setTimeout(() => t.remove(), 300);
  }, duration);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Projects loaded from Supabase after login via onAuthStateChange

</script>
</body>
</html>
